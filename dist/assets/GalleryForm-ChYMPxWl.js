import{C as M,A as O,R as d,j as t}from"./index-DpUnVvi7.js";import{a as p,A as v}from"./AdminApp-DElutmvv.js";import{I as T}from"./ImageUploader-8sQNEsRz.js";import{u as $}from"./useCatalogTargets-B-7ild2u.js";import"./createLucideIcon-DlloiUI2.js";import"./file-text-BcxeLTgw.js";import"./users-Dj4zQjFo.js";import"./newspaper-D6LH_a5a.js";import"./ticket-DJwTfedz.js";import"./chevron-down-BM4ufvPU.js";import"./media-CQLQFIy8.js";function Z(){var I,S,U;const{id:x}=M(),f=O(),u=!!x,[o,b]=d.useState({status:u?"loading":"idle",error:null,form:{media_type:"image",url:"",image_alt:"",title:"",description:"",active:!0,target_type:"none",target_ref_id:null}});d.useEffect(()=>{u&&(async()=>{try{const e=await p.get(v.galleryById(x)),a=(e==null?void 0:e.gallery)||e||{};b(l=>({...l,status:"idle",form:{media_type:a.media_type||"image",url:a.url||"",image_alt:a.image_alt||"",title:a.title||"",description:a.description||"",active:a.active!==void 0?!!a.active:!0,target_type:a.target_type||"none",target_ref_id:a.target_ref_id||null}}))}catch(e){b(a=>({...a,status:"failed",error:e}))}})()},[x,u]);const n=e=>b(a=>({...a,form:{...a.form,...e}})),{attractions:k=[],combos:N=[],status:w}=$(),R=d.useMemo(()=>({attraction:k.map(e=>({value:e.attraction_id||e.id,label:e.title||e.name||`Attraction #${e.attraction_id||e.id}`})),combo:N.map(e=>({value:e.combo_id||e.id,label:e.title||e.name||`Combo #${e.combo_id||e.id}`}))}),[k,N]),L=async e=>{e.preventDefault();try{const{media_type:a,url:l,title:i,description:s,active:y,target_type:h,target_ref_id:_}=o.form;if(!a||!l)throw new Error("Media type and URL are required");const A={media_type:a,url:l,image_alt:o.form.image_alt||"",title:i,description:s,active:y,target_type:h,target_ref_id:h==="none"?null:_||null};u?await p.put(v.galleryById(x),A):await p.post(v.gallery(),A),f("/admin/catalog/gallery")}catch(a){b(l=>({...l,error:a}))}},B="/api/admin/uploads",[c,j]=d.useState([]),[C,E]=d.useState([]),[g,m]=d.useState({uploading:!1,progress:0,error:null});d.useEffect(()=>{const e=(c||[]).map(a=>({name:a.name,url:URL.createObjectURL(a),size:a.size,type:a.type}));return E(e),()=>e.forEach(a=>URL.revokeObjectURL(a.url))},[c]);const P=e=>{const a=Array.from(e.target.files||[]).filter(l=>l&&l.type&&l.type.startsWith("image/"));j(a),m({uploading:!1,progress:0,error:null})},F=e=>j(a=>a.filter((l,i)=>i!==e)),G=async()=>{var l;if(!c.length)return;m({uploading:!0,progress:0,error:null});const e=c.length;let a=0;try{for(const i of c){const s=await p.upload(B,i),y=(s==null?void 0:s.url)||(s==null?void 0:s.secure_url)||(s==null?void 0:s.location)||((l=s==null?void 0:s.data)==null?void 0:l.url)||"";if(!y)throw new Error("Upload response missing URL for "+(i.name||"file"));const h={media_type:"image",url:y,title:i.name,description:"",active:!0,target_type:o.form.target_type||"none",target_ref_id:o.form.target_type==="none"?null:o.form.target_ref_id||null};await p.post(v.gallery(),h),a+=1,m(_=>({..._,progress:Math.round(a/e*100)}))}m(i=>({...i,uploading:!1,progress:100})),f("/admin/catalog/gallery")}catch(i){m({uploading:!1,progress:Math.round(a/e*100),error:i})}};if(o.status==="loading")return t.jsx("div",{children:"Loading…"});if(o.status==="failed")return t.jsx("div",{className:"text-red-600",children:((I=o.error)==null?void 0:I.message)||"Failed to load"});const r=o.form;return t.jsxs("form",{onSubmit:L,className:"max-w-2xl bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl p-4",children:[t.jsxs("h1",{className:"text-xl font-semibold mb-4",children:[u?"Edit":"New"," Gallery Item"]}),o.error?t.jsx("div",{className:"mb-3 text-sm text-red-600",children:((S=o.error)==null?void 0:S.message)||"Save failed"}):null,t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Gallery Category"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_type,onChange:e=>n({target_type:e.target.value,target_ref_id:null}),children:[t.jsx("option",{value:"none",children:"Common Gallery (General)"}),t.jsx("option",{value:"attraction",children:"Attraction Gallery"}),t.jsx("option",{value:"combo",children:"Combo Gallery"})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r.target_type==="none"?"Images will appear in general gallery":r.target_type==="attraction"?"Images will appear only on selected attraction page":"Images will appear only on selected combo page"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Media Type"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.media_type,onChange:e=>n({media_type:e.target.value}),children:[t.jsx("option",{value:"image",children:"Image"}),t.jsx("option",{value:"video",children:"Video"})]})]}),t.jsx("div",{className:"md:col-span-2",children:r.media_type==="image"?t.jsxs("div",{children:[t.jsx(T,{label:"Image",value:r.url,onChange:e=>n({url:e}),altText:r.image_alt,onAltChange:e=>n({image_alt:e}),folder:"gallery",requiredPerm:"uploads:write"}),t.jsxs("div",{className:"mt-4 border-t pt-4",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Bulk Upload Images"}),t.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:P,className:"text-sm"}),C.length?t.jsx("div",{className:"mt-3 grid grid-cols-3 md:grid-cols-6 gap-2",children:C.map((e,a)=>t.jsxs("div",{className:"relative group",children:[t.jsx("img",{src:e.url,alt:e.name,className:"w-full h-24 object-cover rounded-md border"}),t.jsx("button",{type:"button",onClick:()=>F(a),className:"absolute top-1 right-1 bg-white/80 text-xs rounded-full px-2 py-0.5",children:"Remove"})]},e.url))}):t.jsx("div",{className:"mt-2 text-sm text-gray-500",children:"No files selected for bulk upload."}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:G,className:"rounded-md bg-blue-600 text-white px-3 py-1.5 text-sm",disabled:g.uploading||!c.length,children:g.uploading?`Uploading (${g.progress}%)`:"Upload All"}),t.jsx("button",{type:"button",onClick:()=>{j([]),m({uploading:!1,progress:0,error:null})},className:"rounded-md border px-3 py-1.5 text-sm",children:"Clear"}),g.error?t.jsx("div",{className:"text-sm text-red-600",children:((U=g.error)==null?void 0:U.message)||"Upload failed"}):null]})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Video URL"}),t.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",placeholder:"https://…",value:r.url,onChange:e=>n({url:e.target.value})})]})}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Title"}),t.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.title,onChange:e=>n({title:e.target.value})})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Description"}),t.jsx("textarea",{rows:3,className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.description,onChange:e=>n({description:e.target.value})})]}),r.target_type!=="none"?t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:r.target_type==="attraction"?"Select attraction":"Select combo"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_ref_id||"",onChange:e=>n({target_ref_id:e.target.value?Number(e.target.value):null}),disabled:w==="loading",children:[t.jsx("option",{value:"",children:w==="loading"?"Loading…":"Select an option"}),(R[r.target_type]||[]).map(e=>t.jsx("option",{value:e.value||"",children:e.label},`${r.target_type}-${e.value}`))]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r.target_type==="attraction"?"Images will appear only on selected attraction page":"Images will appear only on selected combo page"})]}):null,t.jsxs("div",{className:"flex items-center gap-2 md:col-span-2",children:[t.jsx("input",{id:"active",type:"checkbox",checked:!!r.active,onChange:e=>n({active:e.target.checked})}),t.jsx("label",{htmlFor:"active",className:"text-sm text-gray-700 dark:text-neutral-200",children:"Active"})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Preview"}),t.jsx("div",{className:"w-full h-48 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:r.url?r.media_type==="video"?t.jsx("video",{className:"w-full h-full object-cover",src:r.url,muted:!0,controls:!0,preload:"metadata"}):t.jsx("img",{className:"w-full h-full object-cover",src:r.url,alt:r.title||"Preview"}):t.jsx("div",{className:"text-sm text-gray-500",children:"No media selected"})})]})]}),t.jsxs("div",{className:"mt-4 flex gap-2",children:[t.jsx("button",{type:"submit",className:"rounded-md bg-gray-900 text-white px-4 py-2 text-sm",children:"Save"}),t.jsx("button",{type:"button",className:"rounded-md border px-4 py-2 text-sm",onClick:()=>f(-1),children:"Cancel"})]})]})}export{Z as default};
