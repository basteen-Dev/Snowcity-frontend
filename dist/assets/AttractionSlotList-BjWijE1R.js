import{A as yt,m as ft,R as i,D as A,j as t}from"./index-DpUnVvi7.js";import{a as D}from"./AdminApp-DElutmvv.js";import"./createLucideIcon-DlloiUI2.js";import"./file-text-BcxeLTgw.js";import"./users-Dj4zQjFo.js";import"./newspaper-D6LH_a5a.js";import"./ticket-DJwTfedz.js";import"./chevron-down-BM4ufvPU.js";const C=s=>{if(!s)return"";const[r,d]=String(s).split(":"),x=parseInt(r,10);if(Number.isNaN(x))return s;const l=x>=12?"PM":"AM";return`${x%12||12}:${d??"00"} ${l}`},bt=s=>s?new Date(s).toLocaleString():"N/A",L=s=>{if(s){if(/^\d{2}:\d{2}:\d{2}$/.test(s))return s;if(/^\d{1,2}:\d{2}$/.test(s)){const r=s.split(":");return`${r[0].padStart(2,"0")}:${r[1]}:00`}if(/\s/.test(s)){const r=new Date(`1970-01-01T${s}`);if(!Number.isNaN(r.getTime())){const d=String(r.getHours()).padStart(2,"0"),x=String(r.getMinutes()).padStart(2,"0"),l=String(r.getSeconds()).padStart(2,"0");return`${d}:${x}:${l}`}}}},lt=(s,r)=>!s||!r?!1:s.slice(0,5)===r.slice(0,5),jt=(s={},r={})=>{if(!s||!r||s.booking_date&&r.start_date&&s.booking_date!==r.start_date)return!1;const d=L(r.start_time),x=L(r.end_time),l=s.slot_start_time||s.booking_time,S=s.slot_end_time||null,u=d&&x?lt(d,l||"")&&(!x||lt(x,S||x)):!0;return s.slot_id&&r.slot_id&&String(s.slot_id)===String(r.slot_id)||u},Nt=s=>s?s.item_type==="Combo"&&!s.parent_booking_id?t.jsx("span",{className:"inline-flex items-center rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-medium text-indigo-700 mr-2",children:"Combo parent"}):s.parent_booking_id?t.jsx("span",{className:"inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700 mr-2",children:"Combo child"}):null:null,it=s=>{if(!s)return"";const r=String(s);return r.length>5?r.slice(0,5):r},ot=(s,r,d)=>!s||!r?null:`${s}|${it(r)}|${it(d)}`,q=()=>({bySlotId:Object.create(null),byKey:Object.create(null)}),ct=(s={})=>{const r=Math.max(1,Number(s.quantity||1)),d=Number(s.final_amount??s.total_amount??s.amount??0);return r?d/r:d};function It(){const s=yt(),[r]=ft(),[d,x]=i.useState([]),[l,S]=i.useState(""),[u,z]=i.useState(A().format("YYYY-MM-DD")),[g,U]=i.useState(A().add(1,"year").format("YYYY-MM-DD")),[P,$]=i.useState([]),[V,H]=i.useState(!1),[G,_]=i.useState(""),[h,Q]=i.useState(null),[Y,T]=i.useState([]),[f,dt]=i.useState([]),[w,I]=i.useState(0),[R,K]=i.useState(()=>q()),[mt,J]=i.useState(!1),[W,F]=i.useState(""),N=i.useMemo(()=>!l||l==="undefined"||l==="null"||isNaN(Number(l))?null:Number(l),[l]);i.useEffect(()=>{(async()=>{try{const e=await D.get("/api/admin/attractions",{active:!0}),a=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e)?e:[];x(a);const o=r.get("attraction_id");o&&a.find(n=>(n.attraction_id||n.id)===Number(o))&&S(o)}catch(e){_(e.message||"Failed to load attractions")}})()},[r]);const X=async()=>{var e,a,o;if(console.log("ðŸ” AttractionSlotList load() called"),console.log("ðŸ“‹ attractionId:",l),console.log("ðŸ“‹ attractionId type:",typeof l),console.log("ðŸ“‹ startDate:",u),console.log("ðŸ“‹ endDate:",g),!N){console.log("âŒ Invalid or missing attractionId:",l),$([]),_("Please select an attraction to view slots.");return}console.log("âœ… attractionId is valid, making API call"),H(!0),_("");try{const n=await D.get("/api/admin/attraction-slots",{params:{attraction_id:N,start_date:u,end_date:g}});console.log("âœ… API call successful:",n);const c=Array.isArray(n==null?void 0:n.data)?n.data:Array.isArray(n)?n:[];$(c);const y=Array.from(new Set(c.map(b=>b.start_date))).sort();dt(y);const m=y.indexOf(u);I(m>=0?m:0)}catch(n){console.error("âŒ Failed to load attraction slots:",n),console.error("âŒ Error response:",n.response),console.error("âŒ Error status:",(e=n.response)==null?void 0:e.status),console.error("âŒ Error data:",(a=n.response)==null?void 0:a.data),((o=n.response)==null?void 0:o.status)===400?_("Invalid attraction ID. Please select a valid attraction."):_(n.message||"Failed to load")}finally{H(!1)}};i.useEffect(()=>{console.log("ðŸ”„ AttractionSlotList useEffect triggered"),console.log("ðŸ“‹ Current attractionId:",l),console.log("ðŸ“‹ Dependencies changed:",{attractionId:l,startDate:u,endDate:g}),N?(console.log("âœ… attractionId is valid, calling load()"),X()):(console.log("âŒ No valid attractionId, skipping load()"),$([]),_("Please select an attraction to view slots."))},[N,u,g]),i.useEffect(()=>{if(!f.length)return;const e=f.indexOf(u);e>=0&&I(e)},[u,f]),i.useEffect(()=>{if(!N){K(q()),F("");return}let e=!1;return(async()=>{try{J(!0),F("");const a=await D.get("/api/admin/bookings",{params:{attraction_id:N,date_from:u,date_to:g,limit:500}});if(e)return;const n=(Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[]).filter(m=>(m.booking_status||"").toLowerCase()!=="cancelled"),c=Object.create(null),y=Object.create(null);n.forEach(m=>{const b=m.slot_id!=null?String(m.slot_id):null;b&&(c[b]||(c[b]=[]),c[b].push(m));const j=ot(m.booking_date,m.slot_start_time,m.slot_end_time);j&&(y[j]||(y[j]=[]),y[j].push(m))}),K({bySlotId:c,byKey:y})}catch(a){e||(console.error("Failed to load booking context",a),K(q()),F((a==null?void 0:a.message)||"Failed to load booking context"))}finally{e||J(!1)}})(),()=>{e=!0}},[N,u,g]);const xt=()=>{if(!l||l==="undefined"||l==="null"){alert("Select an attraction before extending slots.");return}const a=(g?A(g):A().add(1,"year")).add(1,"year");U(a.format("YYYY-MM-DD"))};async function ut(e){if(typeof e=="string"&&e.includes("-")){alert("Dynamic slots cannot be deleted. They are generated automatically based on calendar.");return}if(window.confirm("Delete this attraction slot?"))try{await D.delete(`/api/admin/attraction-slots/${e}`),$(a=>a.filter(o=>o.slot_id!==e))}catch(a){alert(a.message||"Delete failed")}}async function pt(e){Q(e);try{const a=await D.get("/api/admin/bookings",{params:{attraction_id:e.attraction_id,date_from:e.start_date,date_to:e.start_date,slot_start_time:L(e.start_time),slot_end_time:L(e.end_time),limit:200}}),o=Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[],n=o.filter(c=>jt(c,e));console.log("ðŸ” Slot inspector match stats:",{slot_id:e.slot_id,bookingCount:o.length,matchedCount:n.length}),T(n.length?n:o)}catch(a){console.error("Failed to fetch bookings:",a),T([])}}function ht(){Q(null),T([])}const Z=e=>{const a=d.find(o=>(o.attraction_id||o.id)===e);return a?a.title||`Attraction #${e}`:`#${e}`},v=f[w],tt=i.useMemo(()=>v?P.filter(e=>e.start_date===v):P,[P,v]),et=i.useMemo(()=>{const e=new Set;return tt.flatMap((a,o)=>{var nt;const n=a.slot_id!=null?String(a.slot_id):null,c=ot(a.start_date,a.start_time,a.end_time),y=n?R.bySlotId[n]||[]:[],m=c?R.byKey[c]||[]:[],b=[...y,...m],j=[],at=new Set;b.forEach(p=>{!p||at.has(p.booking_id)||(at.add(p.booking_id),j.push(p))});const k=j.filter(p=>!!p.parent_booking_id),M=j.filter(p=>!p.parent_booking_id),E=[],st=a.price??a.attraction_price??((nt=a.attraction_details)==null?void 0:nt.price)??null,B=n||c||`${a.start_date}|${o}`;if(E.push({key:`${B}-slot`,slot:a,variant:"slot",variantLabel:"Slot Price",priceValue:st!=null?Number(st):null,bookingCount:0}),M.length){const p=ct(M[0]);E.push({key:`${B}-standalone`,slot:a,variant:"standalone",variantLabel:`Standalone Booking (${M.length})`,priceValue:p,bookingCount:M.length})}if(k.length){const p=ct(k[0]),O=Array.from(new Set(k.map(rt=>rt.combo_title||rt.item_title||"Combo Booking"))),gt=O.length===1?`Combo: ${O[0]}`:`Combo Bookings (${O.length})`;E.push({key:`${B}-combo`,slot:a,variant:"combo",variantLabel:`${gt} â€¢ ${k.length} booking(s)`,priceValue:p,bookingCount:k.length})}return e.add(B),E})},[tt,R]);return t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("select",{className:"rounded-md border px-3 py-2",value:l,onChange:e=>S(e.target.value),children:[t.jsx("option",{value:"",children:"Select attraction"}),d.map(e=>t.jsx("option",{value:e.attraction_id||e.id,children:e.title||`Attraction #${e.attraction_id||e.id}`},e.attraction_id||e.id))]}),t.jsx("input",{type:"date",className:"rounded-md border px-3 py-2",value:u,onChange:e=>z(e.target.value)}),t.jsx("input",{type:"date",className:"rounded-md border px-3 py-2",value:g,onChange:e=>U(e.target.value)}),t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:X,children:"Filter"}),t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:xt,disabled:!l,children:"Generate Next Year"})]}),l&&t.jsx("div",{className:"mb-3",children:t.jsx("button",{className:"rounded-md bg-blue-600 text-white px-3 py-2 text-sm",onClick:()=>s(`/admin/catalog/attractions/${l}`),children:"Edit Attraction"})}),G?t.jsx("div",{className:"text-sm text-red-600",children:G}):null,W?t.jsxs("div",{className:"text-xs text-amber-600",children:["Context: ",W]}):null,mt?t.jsx("div",{className:"text-xs text-gray-500",children:"Loading booking contextâ€¦"}):null,t.jsx("div",{className:"overflow-x-auto rounded-lg border bg-white dark:bg-neutral-900 border-gray-200 dark:border-neutral-800",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800 text-gray-600 dark:text-neutral-300",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Date"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Time"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Attraction"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Context"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Capacity"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Bookings"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Status / Bookings"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Actions"})]})}),t.jsx("tbody",{className:"text-gray-800 dark:text-neutral-200",children:et.length>0?et.map(e=>{const a=e.variant==="slot",o=e.bookingCount>0?`${e.bookingCount}`:"0",n=e.slot;return t.jsxs("tr",{className:`border-t border-gray-200 dark:border-neutral-800 hover:bg-gray-50 dark:hover:bg-neutral-800 cursor-pointer ${a?"":"bg-gray-50/60 dark:bg-neutral-800/40"}`,onClick:()=>pt(n),children:[t.jsx("td",{className:"px-3 py-2",children:n.start_date}),t.jsxs("td",{className:"px-3 py-2",children:[C(n.start_time)," â†’ ",C(n.end_time)]}),t.jsx("td",{className:"px-3 py-2",children:n.attraction_name||Z(n.attraction_id)}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.variant!=="slot"&&t.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-gray-400","aria-hidden":"true"}),e.variantLabel]})}),t.jsx("td",{className:"px-3 py-2",children:a?n.capacity:"â€”"}),t.jsx("td",{className:"px-3 py-2",children:o}),t.jsx("td",{className:"px-3 py-2",children:a?t.jsx("span",{className:`px-2 py-1 text-xs rounded ${n.available?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:n.available?"Available":"Unavailable"}):t.jsxs("span",{className:"text-xs text-gray-600 dark:text-neutral-400",children:["Bookings: ",e.bookingCount]})}),t.jsx("td",{className:"px-3 py-2",children:a?t.jsx("button",{className:"rounded-md border px-2 py-1 text-xs text-red-600",onClick:c=>{c.stopPropagation(),ut(n.slot_id)},children:"Delete"}):"â€”"})]},e.key)}):t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:8,children:V?"Loadingâ€¦":l?"No attraction slots for this date":"Select an attraction to view slots"})})})]})}),f.length>1&&t.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[t.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>I(e=>Math.max(0,e-1)),disabled:w===0,children:"Prev Date"}),t.jsxs("div",{className:"text-gray-600",children:[v?A(v).format("DD MMM YYYY"):"â€”"," (",w+1," / ",f.length,")"]}),t.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>I(e=>Math.min(f.length-1,e+1)),disabled:w>=f.length-1,children:"Next Date"})]}),V?t.jsx("div",{className:"text-sm text-gray-500",children:"Loadingâ€¦"}):null,h&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white dark:bg-neutral-900 rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-auto",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Slot Details & Bookings"}),t.jsx("button",{onClick:ht,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"âœ•"})]}),t.jsxs("div",{className:"bg-gray-50 dark:bg-neutral-800 p-4 rounded-lg mb-4",children:[t.jsx("h3",{className:"font-medium mb-2",children:"Slot Information"}),t.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("strong",{children:"Attraction:"})," ",h.attraction_name||Z(h.attraction_id)]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Date:"})," ",h.start_date]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Time:"})," ",C(h.start_time)," â†’ ",C(h.end_time)]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Capacity:"})," ",h.capacity]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Price:"})," ",h.price==null?"N/A":`â‚¹${Number(h.price).toLocaleString()}`]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Available:"})," ",h.available?"Yes":"No"]})]})]}),t.jsxs("div",{children:[t.jsxs("h3",{className:"font-medium mb-2",children:["Bookings (",Y.length,")"]}),Y.length>0?t.jsx("div",{className:"border rounded-lg overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Booking ID"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Customer"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Email"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Qty"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Status"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Amount"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Booking Time"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Booked At"})]})}),t.jsx("tbody",{children:Y.map(e=>t.jsxs("tr",{className:"border-t dark:border-neutral-800",children:[t.jsxs("td",{className:"px-3 py-2",children:["#",e.booking_id,e.parent_booking_id?t.jsxs("div",{className:"text-[11px] text-gray-500",children:["Parent #",e.parent_booking_id]}):null]}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{children:e.customer_name||e.user_name||"N/A"}),t.jsx("span",{className:"text-xs text-gray-500",children:e.item_title||e.attraction_title||e.combo_title||"â€”"})]})}),t.jsx("td",{className:"px-3 py-2",children:e.customer_email||e.user_email||"N/A"}),t.jsx("td",{className:"px-3 py-2",children:e.quantity?`${e.quantity}`:"1"}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("span",{className:`px-2 py-1 text-xs rounded ${e.booking_status==="Confirmed"||e.booking_status==="Booked"?"bg-green-100 text-green-800":e.booking_status==="Pending"?"bg-yellow-100 text-yellow-800":e.booking_status==="Cancelled"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:e.booking_status||"Unknown"}),Nt(e)]})}),t.jsxs("td",{className:"px-3 py-2 text-right",children:["â‚¹",Number(e.total_amount||e.amount||0).toLocaleString()]}),t.jsx("td",{className:"px-3 py-2",children:C(e.slot_start_time||e.booking_time)}),t.jsx("td",{className:"px-3 py-2",children:bt(e.created_at)})]},e.booking_id))})]})}):t.jsx("div",{className:"text-gray-500 text-center py-4",children:"No bookings found for this slot"})]})]})})]})}export{It as default};
