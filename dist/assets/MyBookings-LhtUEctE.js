import{h as ee,C as te,u as N,r as x,X as O,j as e,E as G,V as se,W as ae,Y as re,Z as ne}from"./index-C5Mz9dTM.js";import{f as h}from"./formatters-CmiLqhJj.js";import{t as oe}from"./media-DDlhmRHE.js";import{R as k,E as le}from"./refresh-ccw-DUyB1j_-.js";import{c as ie}from"./createLucideIcon-DQ6FqzLt.js";import{C as de,F as ce}from"./file-text-CQ7rExmv.js";import{C,P as U}from"./plus-D5Q8_bOm.js";import{C as E}from"./circle-check-big-BKICz5jg.js";import{C as $}from"./circle-alert-B_8ts0Q-.js";import{C as F}from"./clock-m8MB6VK0.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],L=ie("chevron-up",me),xe=({text:s,tone:n})=>{const c={green:"bg-green-100 text-green-700 border-green-200",red:"bg-red-100 text-red-700 border-red-200",yellow:"bg-yellow-100 text-yellow-800 border-yellow-200",gray:"bg-gray-100 text-gray-700 border-gray-200",blue:"bg-blue-100 text-blue-700 border-blue-200"};return e.jsx("span",{className:`px-2.5 py-0.5 rounded-full text-xs font-medium border ${c[n]||c.gray}`,children:s})},ge=s=>{const n=String(s||"").trim().toUpperCase();return["COMPLETED","SUCCESS","PAID","CONFIRMED"].includes(n)?{tone:"green",icon:E,label:"Paid"}:["FAILED","DECLINED","CANCELLED","CANCELED"].includes(n)?{tone:"red",icon:$,label:"Failed"}:["PENDING","PENDING_PAYMENT","AWAITING_PAYMENT"].includes(n)?{tone:"yellow",icon:F,label:"Pending"}:{tone:"yellow",icon:F,label:"Pending"}},ue=s=>{const n=String(s||"").replace(/\D/g,"");return n.length>=10?n.slice(-10):n},P=s=>{if(!s)return"";const[n,c]=String(s).split(":");if(!n||!c)return"";const i=parseInt(n,10),g=i>=12?"PM":"AM";return`${i%12||12}:${c} ${g}`},he=(s=[])=>{if(!Array.isArray(s)||!s.length)return[];const n=new Map;s.forEach(i=>{n.set(i.booking_id,{...i,child_items:[]})}),n.forEach(i=>{i.parent_booking_id&&n.has(i.parent_booking_id)&&n.get(i.parent_booking_id).child_items.push(i)});const c=Array.from(n.values()).filter(i=>!i.parent_booking_id);return c.length?c:Array.from(n.values())},pe=s=>s?String(s.item_type).toLowerCase()==="combo"?s.combo_title||s.combo_name||s.item_title||(s.combo_id?`Combo #${s.combo_id}`:"Combo"):s.item_title||s.attraction_title||"Ticket":"Ticket",fe=s=>{console.log("ðŸ” DEBUG MyBookings item data:",{booking_id:s.booking_id,slot_start_time:s.slot_start_time,slot_end_time:s.slot_end_time,start_time:s.start_time,end_time:s.end_time,slot_label:s.slot_label,booking_time:s.booking_time,full_item:s});const n=P(s.slot_start_time||s.start_time),c=P(s.slot_end_time||s.end_time);if(n&&c){const g=`${n} - ${c}`;return console.log("ðŸ” DEBUG MyBookings using start/end times:",g),g}if(n)return console.log("ðŸ” DEBUG MyBookings using start time only:",n),n;if(s.slot_label)return console.log("ðŸ” DEBUG MyBookings using slot_label:",s.slot_label),s.slot_label;const i=P(s.booking_time)||"Slot Time";return console.log("ðŸ” DEBUG MyBookings using booking_time fallback:",i),i};function Ee(){const s=ee(),n=te(),{status:c,items:i,error:g}=N(t=>t.bookings.list),_=N(t=>t.bookings.payphi);N(t=>t.bookings.phonepe);const d=N(t=>{var r;return(r=t.auth)==null?void 0:r.user}),S=x.useMemo(()=>{if(!Array.isArray(i))return[];const t=new Map;return i.forEach(r=>{const l=r.order_id||r.booking_id||r.id;t.has(l)||t.set(l,{id:l,ref:r.order_ref||r.booking_ref,date:r.created_at,status:r.payment_status,items:[],calculatedTotal:0}),t.get(l).items.push(r)}),t.forEach(r=>{r.primaryItems=he(r.items),r.primaryItems.forEach(o=>{Array.isArray(o.child_items)&&o.child_items.length&&(o.child_items=[...o.child_items].sort((m,b)=>{const y=m.slot_start_time||m.booking_time||"",a=b.slot_start_time||b.booking_time||"";return String(y).localeCompare(String(a))}))});const l=r.primaryItems.length?r.primaryItems:r.items;r.itemCount=l.length,r.calculatedTotal=l.reduce((o,m)=>o+Number(m.final_amount||m.total_amount||0),0)}),Array.from(t.values()).sort((r,l)=>new Date(l.date)-new Date(r.date))},[i]),[R,q]=x.useState(null),[Y,v]=x.useState(null),[M,D]=x.useState(""),[I,A]=x.useState(""),[u,T]=x.useState("payphi"),[V,p]=x.useState(!1),[f,w]=x.useState(null);x.useEffect(()=>{s(O({page:1,limit:50}))},[s]),x.useEffect(()=>{D((d==null?void 0:d.email)||""),A((d==null?void 0:d.phone)||"")},[d]);const z=()=>s(O({page:1,limit:50})),W=async t=>{const r=(M||(d==null?void 0:d.email)||"").trim(),l=ue(I||(d==null?void 0:d.phone)||"");if(!r||!l||l.length<10){alert("Please enter a valid email and 10-digit mobile to continue.");return}try{let o;u==="phonepe"?o=await s(se({bookingId:t.id,email:r,mobile:l,amount:t.calculatedTotal})).unwrap():o=await s(ae({bookingId:t.id,email:r,mobile:l,amount:t.calculatedTotal})).unwrap(),o!=null&&o.redirectUrl?window.location.href=o.redirectUrl:alert("Payment initiation failed. Please try again.")}catch(o){console.error("Payment retry error:",o),alert(`Payment failed: ${o.message||"Unknown error"}`)}},J=async t=>{var r;try{(((r=i.filter(m=>m.order_id===t)[0])==null?void 0:r.payment_mode)||"PayPhi")==="PhonePe"?await s(re({bookingId:t})).unwrap():await s(ne({bookingId:t})).unwrap(),z()}catch(l){console.error("Status check error:",l),alert("Failed to check payment status. Please try again.")}},B=(t=null)=>{var r,l;t&&localStorage.setItem("pendingOrderData",JSON.stringify({orderRef:t.ref,email:((r=t.items[0])==null?void 0:r.customer_email)||(d==null?void 0:d.email),mobile:((l=t.items[0])==null?void 0:l.customer_mobile)||(d==null?void 0:d.phone),items:t.items.map(o=>({attraction_id:o.attraction_id,combo_id:o.combo_id,quantity:o.quantity,date:o.booking_date}))})),n("/booking")},Q=t=>{w(t),p(!0)};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-[#e0f2fe] via-[#bae6fd] to-white px-4 pt-20 pb-8",children:[e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"My Orders"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Track your tickets and payment status"})]}),e.jsx("button",{onClick:z,disabled:c==="loading",className:"p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors",title:"Refresh List",children:e.jsx(k,{size:20,className:c==="loading"?"animate-spin":""})})]}),c==="failed"&&e.jsx("div",{className:"bg-red-50 text-red-700 p-4 rounded-lg mb-6 text-sm text-center",children:(g==null?void 0:g.message)||"Failed to load orders."}),c==="succeeded"&&S.length===0&&e.jsx("div",{className:"text-center py-12 bg-gray-50 rounded-2xl border border-dashed border-gray-300",children:e.jsx("p",{className:"text-gray-500",children:"No orders found."})}),e.jsx("div",{className:"space-y-6",children:S.map(t=>{var y;const r=ge(t.status),l=r.icon,o=R===t.id,m=Y===t.id,b=r.label==="Pending";return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden transition-all hover:shadow-md",children:[e.jsxs("div",{className:"p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 cursor-pointer select-none",onClick:()=>q(o?null:t.id),children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${r.tone==="green"?"bg-green-50 text-green-600":r.tone==="red"?"bg-red-50 text-red-600":"bg-yellow-50 text-yellow-600"}`,children:e.jsx(l,{size:24})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["Order #",t.ref]}),e.jsx(xe,{text:r.label,tone:r.tone})]}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:G(t.date).format("DD MMM YYYY â€¢ h:mm A")}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[t.itemCount||t.items.length," Item",(t.itemCount||t.items.length)!==1&&"s"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between md:justify-end gap-6 w-full md:w-auto",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-semibold mb-1",children:"Total"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:h(t.calculatedTotal)})]}),e.jsx("div",{className:"text-gray-400",children:o?e.jsx(L,{size:24}):e.jsx(de,{size:24})})]})]}),o&&e.jsxs("div",{className:"border-t border-gray-100 bg-gray-50/50 p-5 animate-slide-down",children:[e.jsx("h4",{className:"text-xs font-bold text-gray-500 uppercase mb-3",children:"Order Items"}),e.jsx("div",{className:"space-y-3",children:(t.primaryItems&&t.primaryItems.length?t.primaryItems:t.items).map((a,X)=>{const Z=fe(a),H=Number(a.final_amount||a.total_amount||0);return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200 flex flex-col md:flex-row md:items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800 text-base",children:pe(a)}),e.jsxs("div",{className:"text-sm text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{children:G(a.booking_date).format("DD MMM")}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsx("span",{children:Z}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsxs("span",{children:["Qty: ",a.quantity]})]}),a.addons&&a.addons.length>0&&e.jsxs("div",{className:"mt-2 p-2 bg-gray-50 rounded text-xs",children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Add-ons:"}),a.addons.map((j,K)=>e.jsxs("div",{className:"text-gray-600",children:["â€¢ ",j.title," x",j.quantity," (",h(j.price*j.quantity),")"]},K))]}),a.offer&&e.jsxs("div",{className:"mt-2 p-2 bg-green-50 rounded text-xs",children:[e.jsx("div",{className:"font-semibold text-green-700 mb-1",children:"Offer Applied:"}),e.jsxs("div",{className:"text-green-600",children:[a.offer.title,a.offer.description&&e.jsx("div",{className:"text-green-500 mt-1",children:a.offer.description}),a.offer.rule_type==="buy_x_get_y"&&a.offer.buy_qty&&a.offer.get_qty&&e.jsxs("div",{className:"text-green-500 mt-1",children:["Buy ",a.offer.buy_qty," Get ",a.offer.get_qty,a.offer.get_discount_type==="percent"&&a.offer.get_discount_value&&e.jsxs("span",{children:[" (",a.offer.get_discount_value,"% off)"]}),a.offer.get_discount_type==="amount"&&a.offer.get_discount_value&&e.jsxs("span",{children:[" (",h(a.offer.get_discount_value)," off)"]}),!a.offer.get_discount_value&&e.jsx("span",{children:" Free"})]}),a.offer.rule_type!=="buy_x_get_y"&&a.offer.discount_type==="percent"&&e.jsxs("div",{className:"text-green-500",children:[a.offer.discount_percent,"% discount"]}),a.offer.rule_type!=="buy_x_get_y"&&a.offer.discount_type==="amount"&&e.jsxs("div",{className:"text-green-500",children:[h(a.offer.discount_value)," off"]})]})]})]}),e.jsx("div",{className:"font-bold text-gray-900",children:h(H)})]},X)})}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-3 border-t border-gray-200 pt-4",children:[r.label==="Paid"&&e.jsxs("a",{href:oe((y=t.items[0])==null?void 0:y.ticket_pdf),target:"_blank",rel:"noreferrer",className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(ce,{size:18})," Download Ticket(s)"]}),e.jsxs("button",{onClick:a=>{a.stopPropagation(),J(t.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(k,{size:18})," Check Status"]}),b&&!m&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),v(t.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm ml-auto",children:[e.jsx(C,{size:18})," Pay Now"]}),r.label==="Failed"&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),Q(t)},className:"flex items-center gap-2 px-4 py-2.5 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700 transition-colors shadow-sm ml-auto",children:[e.jsx(k,{size:18})," Try Again"]}),t.items.length>0&&t.items.some(a=>a.attraction_id)&&e.jsxs("button",{onClick:a=>{a.stopPropagation(),B(t)},className:"flex items-center gap-2 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors shadow-sm",children:[e.jsx(U,{size:18})," Book Similar"]})]}),m&&e.jsxs("div",{className:"mt-4 bg-white border border-blue-100 rounded-xl p-4 shadow-sm animate-in fade-in slide-in-from-top-2",children:[e.jsxs("h5",{className:"text-sm font-bold text-gray-800 mb-3",children:["Complete Payment for Order #",t.ref]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Email"}),e.jsx("input",{type:"email",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:M,onChange:a=>D(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Mobile"}),e.jsx("input",{type:"tel",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:I,onChange:a=>A(a.target.value)})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-700 mb-3",children:"Select Payment Gateway"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:`flex flex-col items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${u==="payphi"?"border-blue-600 bg-gradient-to-br from-blue-50 to-sky-50 shadow-md":"border-gray-200 bg-white hover:border-blue-300"}`,children:[e.jsx("input",{type:"radio",name:"retryGateway",value:"payphi",checked:u==="payphi",onChange:()=>T("payphi"),className:"sr-only"}),e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center mb-2 shadow-sm",children:e.jsx(C,{size:24,className:"text-white"})}),e.jsx("span",{className:"text-sm font-bold text-gray-900",children:"PayPhi"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"All Methods"}),u==="payphi"&&e.jsx("div",{className:"mt-2 w-5 h-5 rounded-full bg-blue-600 flex items-center justify-center",children:e.jsx(E,{size:16,className:"text-white"})})]}),e.jsxs("label",{className:`flex flex-col items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${u==="phonepe"?"border-purple-600 bg-gradient-to-br from-purple-50 to-indigo-50 shadow-md":"border-gray-200 bg-white hover:border-purple-300"}`,children:[e.jsx("input",{type:"radio",name:"retryGateway",value:"phonepe",checked:u==="phonepe",onChange:()=>T("phonepe"),className:"sr-only"}),e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center mb-2 shadow-sm",children:e.jsx("svg",{className:"w-7 h-7 text-white",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"})})}),e.jsx("span",{className:"text-sm font-bold text-gray-900",children:"PhonePe"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"UPI & More"}),u==="phonepe"&&e.jsx("div",{className:"mt-2 w-5 h-5 rounded-full bg-purple-600 flex items-center justify-center",children:e.jsx(E,{size:16,className:"text-white"})})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>W(t),disabled:_.status==="loading",className:"px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 shadow-md transition-all",children:_.status==="loading"?"Processing...":"Proceed to Payment Gateway"}),e.jsx("button",{onClick:()=>v(null),className:"px-4 py-2 text-gray-500 text-sm hover:text-gray-700 font-medium",children:"Cancel"})]})]})]})]},t.id)})})]}),V&&f&&e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6 animate-in fade-in slide-in-from-bottom-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:"Payment Options"}),e.jsx("button",{onClick:()=>{p(!1),w(null)},className:"p-2 rounded-full hover:bg-gray-100 text-gray-500 transition-colors",children:e.jsx(L,{size:20,className:"rotate-45"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx($,{className:"text-red-600",size:24}),e.jsx("h4",{className:"font-bold text-red-800",children:"Payment Failed"})]}),e.jsxs("p",{className:"text-red-700 text-sm mb-3",children:["Your payment for order ",e.jsxs("span",{className:"font-mono font-bold",children:["#",f.ref]})," could not be processed. Please try again or contact support if the issue persists."]}),e.jsxs("div",{className:"text-xs text-red-600 bg-red-100 rounded-lg p-2",children:[e.jsx("strong",{children:"Next Steps:"}),e.jsx("br",{}),"1. Check your payment details",e.jsx("br",{}),"2. Ensure sufficient funds",e.jsx("br",{}),"3. Try a different payment method",e.jsx("br",{}),"4. Contact support if issue continues"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:()=>{v(f.id),p(!1)},className:"w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg",children:[e.jsx(C,{size:20}),"Retry Payment"]}),e.jsxs("button",{onClick:()=>B(f),className:"w-full flex items-center justify-center gap-2 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors shadow-lg",children:[e.jsx(U,{size:20}),"Book New Tickets"]}),e.jsx("button",{onClick:()=>{p(!1),w(null)},className:"w-full flex items-center justify-center gap-2 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-colors",children:"Cancel"})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(le,{size:16}),e.jsx("span",{children:"Need help? Contact our support team"})]})})]})]})})]})}export{Ee as default};
