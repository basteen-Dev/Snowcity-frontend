import{B as A,R as f,j as t}from"./index-Buz5vlJT.js";import{a as p,A as u}from"./AdminApp-DjyjDDmt.js";import{A as C}from"./AdminTable-BEVjuUza.js";import"./createLucideIcon-BEwYts5j.js";import"./file-text-CuRCFKVY.js";import"./ticket-B65mU2v0.js";function D(){var j,v;const h=A(),[i,n]=f.useState({status:"idle",items:[],error:null,q:"",active:"",page:1,limit:20,meta:null}),[d,x]=f.useState({open:!1,status:"idle",offer:null,slots:[],error:null}),m=async(e=1)=>{n(s=>({...s,status:"loading",error:null,page:e}));try{const s=await p.get(u.offers(),{params:{q:i.q||void 0,active:i.active||void 0,page:e,limit:i.limit}}),l=Array.isArray(s==null?void 0:s.data)?s.data:Array.isArray(s)?s:[];n(a=>({...a,status:"succeeded",items:l,meta:(s==null?void 0:s.meta)||null,page:e}))}catch(s){n(l=>({...l,status:"failed",error:s}))}},N=async(e,s)=>{var a;(a=s==null?void 0:s.stopPropagation)==null||a.call(s);const l=e.offer_id||e.id;x({open:!0,status:"loading",offer:e,slots:[],error:null});try{const r=await p.get(`${u.offers()}/${l}/slots`,{params:{limit:1e3}}),c=Array.isArray(r==null?void 0:r.slots)?r.slots:[];x({open:!0,status:"succeeded",offer:(r==null?void 0:r.offer)||e,slots:c,error:null})}catch(r){x(c=>({...c,status:"failed",error:r}))}},b=()=>x({open:!1,status:"idle",offer:null,slots:[],error:null});f.useEffect(()=>{m(1)},[]);const _=async(e,s)=>{var l;(l=s==null?void 0:s.stopPropagation)==null||l.call(s);try{const a=e.offer_id||e.id;await p.put(`${u.offers()}/${a}`,{active:!e.active}),n(r=>({...r,items:r.items.map(c=>(c.offer_id||c.id)===a?{...c,active:!e.active}:c)}))}catch(a){alert((a==null?void 0:a.message)||"Failed to update")}},k=async(e,s)=>{var l;if((l=s==null?void 0:s.stopPropagation)==null||l.call(s),!!window.confirm(`Delete offer "${e.title}"? This cannot be undone.`))try{const a=e.offer_id||e.id;await p.delete(`${u.offers()}/${a}`),n(r=>({...r,items:r.items.filter(c=>(c.offer_id||c.id)!==a)}))}catch(a){alert((a==null?void 0:a.message)||"Delete failed")}},o=i.meta||{},y=i.page>1,g=o.page?o.page<(o.totalPages||o.total_pages||1):!1;return t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h1",{className:"text-xl font-semibold",children:"Offers"}),t.jsx("button",{className:"rounded-md bg-gray-900 text-white px-3 py-2 text-sm",onClick:()=>h("/admin/catalog/offers/new"),children:"New Offer"})]}),t.jsxs("div",{className:"mb-3 grid grid-cols-1 md:grid-cols-4 gap-2",children:[t.jsx("input",{className:"rounded-md border px-3 py-2",placeholder:"Search title",value:i.q,onChange:e=>n(s=>({...s,q:e.target.value}))}),t.jsxs("select",{className:"rounded-md border px-3 py-2",value:i.active,onChange:e=>n(s=>({...s,active:e.target.value})),children:[t.jsx("option",{value:"",children:"Active: All"}),t.jsx("option",{value:"true",children:"Active"}),t.jsx("option",{value:"false",children:"Inactive"})]}),t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>m(1),children:"Filter"})]}),t.jsx(C,{keyField:"offer_id",columns:[{key:"title",title:"Title"},{key:"discount_summary",title:"Discount",render:e=>{const s=(e.discount_type||"percent").toLowerCase(),l=Number(e.discount_value??e.discount_percent??0);return l?s==="amount"?`₹${l}`:`${l}%`:"—"}},{key:"rule_type",title:"Rule"},{key:"rule_count",title:"Rules",render:e=>Number(e.rule_count??0)},{key:"valid_from",title:"From"},{key:"valid_to",title:"To"},{key:"active",title:"Active",render:e=>String(e==null?void 0:e.active)},{key:"__actions",title:"Actions",render:e=>t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx("button",{className:`rounded-md px-2 py-1 text-xs ${e.active?"border text-red-600":"bg-blue-600 text-white"}`,onClick:s=>_(e,s),children:e.active?"Deactivate":"Activate"}),t.jsx("button",{className:"rounded-md border px-2 py-1 text-xs",onClick:s=>N(e,s),children:"View Slots"}),t.jsx("button",{className:"rounded-md border px-2 py-1 text-xs text-red-600",onClick:s=>k(e,s),children:"Delete"})]})}],rows:i.items,onRowClick:e=>h(`/admin/catalog/offers/${e.offer_id||e.id}`),empty:i.status==="loading"?"Loading…":"No offers found"}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>y&&m(i.page-1),disabled:!y||i.status==="loading",children:"Prev"}),t.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",o.page||i.page]}),t.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>g&&m(i.page+1),disabled:!g||i.status==="loading",children:"Next"})]}),d.open&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:t.jsxs("div",{className:"bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-auto",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b dark:border-neutral-800",children:[t.jsxs("div",{children:[t.jsxs("h2",{className:"text-lg font-semibold",children:["Offer Slots – ",(j=d.offer)==null?void 0:j.title]}),t.jsx("p",{className:"text-xs text-gray-500",children:"Showing slots matched by current rules"})]}),t.jsx("button",{className:"text-sm text-gray-500 hover:text-gray-800",onClick:b,children:"Close"})]}),t.jsxs("div",{className:"p-4 space-y-4",children:[d.status==="loading"&&t.jsx("div",{className:"text-sm text-gray-500",children:"Loading slots…"}),d.status==="failed"&&t.jsx("div",{className:"text-sm text-red-600",children:((v=d.error)==null?void 0:v.message)||"Failed to load slots"}),d.status==="succeeded"&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"text-sm text-gray-600",children:[d.slots.length," slots matched"]}),t.jsx("div",{className:"overflow-auto border rounded-xl",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Type"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Target"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Date"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Time"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Capacity"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Price"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Rule"})]})}),t.jsxs("tbody",{children:[d.slots.map((e,s)=>{var l,a;return t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"px-3 py-2 capitalize",children:((l=e._match)==null?void 0:l.type)||"attraction"}),t.jsx("td",{className:"px-3 py-2",children:e.attraction_title||e.combo_name||e.combo_id||e.attraction_id||"—"}),t.jsxs("td",{className:"px-3 py-2",children:[e.start_date,e.end_date&&e.end_date!==e.start_date?` → ${e.end_date}`:""]}),t.jsxs("td",{className:"px-3 py-2",children:[e.start_time," – ",e.end_time]}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.capacity??"—"}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.price==null?"—":`₹${Number(e.price).toLocaleString()}`}),t.jsxs("td",{className:"px-3 py-2 text-xs text-gray-500",children:["Rule #",(a=e._match)==null?void 0:a.rule_id]})]},`offer-slot-${s}`)}),!d.slots.length&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-4 text-center text-gray-500",colSpan:7,children:"No slots matched this offer"})})]})]})})]})]})]})})]})}export{D as default};
