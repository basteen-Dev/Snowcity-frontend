import{C as kt,B as At,h as Dt,R as x,D as w,i as I,k as $,j as e,A as Q,L as Yt,E as Ct,F as Lt}from"./index-Buz5vlJT.js";import{E}from"./ErrorState-DW0DLMd4.js";import{g as W}from"./ids-YExsbyMi.js";import{i as U}from"./media-DTTax9V0.js";import{g as Pt,a as St,c as Bt,d as it,b as Tt}from"./pricing-CIeFTiJd.js";import{f as Y}from"./formatters-CmiLqhJj.js";const z=t=>w(t).format("YYYY-MM-DD"),lt=()=>w().format("YYYY-MM-DD"),V=(t,i)=>String((t==null?void 0:t.id)??(t==null?void 0:t._id)??(t==null?void 0:t.slot_id)??`${(t==null?void 0:t.start_time)||""}-${(t==null?void 0:t.end_time)||""}-${i}`),ot=t=>{if(!t)return"";const[i,c]=t.split(":"),l=parseInt(i,10),d=l>=12?"PM":"AM";return`${l%12||12}:${c} ${d}`},ct=t=>{if(t!=null&&t.label)return t.label;const i=ot(t==null?void 0:t.start_time),c=ot(t==null?void 0:t.end_time);return i&&c?`${i} - ${c}`:i||`Slot #${(t==null?void 0:t.id)??(t==null?void 0:t._id)??(t==null?void 0:t.slot_id)??"?"}`},J=t=>{if(!t||typeof t!="string")return null;const[i="0",c="0"]=t.split(":"),l=Number(i),d=Number(c);return!Number.isFinite(l)||!Number.isFinite(d)?null:l*60+d},Ft=(t={},i)=>{if(!t.day_type)return!0;const c=w(i).day(),l=String(t.day_type).toLowerCase();return l==="weekday"?c>=1&&c<=5:l==="weekend"?c===0||c===6:l==="custom"&&Array.isArray(t.specific_days)?t.specific_days.map(Number).includes(c):!0},dt=t=>String(t||"").toLowerCase(),ut=(t,i)=>t==null||i==null?!1:String(t)===String(i),It=t=>{if(typeof t=="boolean")return t;if(t==null)return!1;if(typeof t=="number")return t!==0;const i=String(t).trim().toLowerCase();return i?["true","1","yes","y"].includes(i)?!0:["false","0","no","n"].includes(i)?!1:!!t:!1},$t=(t={},i=null)=>{if(!i)return!(t.slot_id!=null||Array.isArray(t.slot_ids)&&t.slot_ids.length||t.specific_time||t.time_from&&t.time_to);const c=[];if(t.slot_id!=null&&c.push(t.slot_id),Array.isArray(t.slot_ids)&&c.push(...t.slot_ids),t.target_slot_id!=null&&c.push(t.target_slot_id),c.length){const d=[i.slot_id,i.id,i._id,i.combo_slot_id].filter(o=>o!=null);if(!c.some(o=>d.some(h=>ut(o,h))))return!1}const l=i.start_time||i.time||i.startTime||null;if(t.specific_time&&l&&l.slice(0,5)!==String(t.specific_time).slice(0,5))return!1;if(t.time_from&&t.time_to&&l){const d=J(l),m=J(t.time_from),o=J(t.time_to);if(d==null||m==null||o==null||d<m||d>o)return!1}return!0},Et=(t,{targetType:i,targetId:c,date:l,slot:d})=>{if(!t||!i||!c)return!1;const m=w(l).format("YYYY-MM-DD"),o=dt(t.target_type),h=dt(i);if(o&&h&&o!==h)return!1;if(!It(t.applies_to_all)){const p=[];if(t.target_id!=null&&p.push(t.target_id),Array.isArray(t.target_ids)&&p.push(...t.target_ids),!p.length||!p.some(y=>ut(y,c)))return!1}return!(t.specific_date&&m!==t.specific_date||Array.isArray(t.specific_dates)&&t.specific_dates.length&&!t.specific_dates.some(p=>w(p).format("YYYY-MM-DD")===m)||t.date_from&&m<t.date_from||t.date_to&&m>t.date_to||!Ft(t,m)||!$t(t,d))},Ut=(t={},i=null,c=0)=>{const l=Number(c);if(!l||l<=0)return 0;let d=(i==null?void 0:i.rule_discount_type)||t.discount_type||(t.discount_percent?"percent":null),m=(i==null?void 0:i.rule_discount_value)??t.discount_value??t.discount_percent??0;if(!d||!m)return 0;d=String(d).toLowerCase();let o=d==="amount"?Number(m):Number(m)/100*l;return Number.isFinite(Number(t.max_discount))&&(o=Math.min(o,Number(t.max_discount))),o=Math.min(o,l),Math.max(0,o)},zt=(t=[],{targetType:i,targetId:c,date:l,slot:d,basePrice:m})=>{if(!Array.isArray(t)||!t.length||!m||!c)return null;let o=null;return t.forEach(h=>{(Array.isArray(h.rules)&&h.rules.length?h.rules:[null]).forEach(p=>{if(p&&!Et(p,{targetType:i,targetId:c,date:l,slot:d}))return;const y=Ut(h,p,m);if(!y)return;const A=Math.max(0,m-y);(!o||A<o.price)&&(o={offer:h,rule:p,price:A,discount:y})})}),o},mt=(t,i)=>{if(!t||!i)return!0;const c=w().format("YYYY-MM-DD"),l=w(i).format("YYYY-MM-DD");if(l>c)return!0;if(l===c){const d=w(),m=t.start_time||t.time||null;if(!m)return!0;const[o,h]=m.split(":").map(Number),b=(o||0)*60+(h||0),y=d.hour()*60+d.minute()+60;return b>=y}return!1};function Vt(){var nt;const{id:t}=kt(),i=At(),c=Dt(),l=x.useMemo(()=>!t||t==="undefined"||t==="null"?null:t,[t]),[d,m]=x.useState({status:"idle",data:null,error:null}),[o,h]=x.useState(lt()),[b,p]=x.useState({status:"idle",items:[],error:null}),[y,A]=x.useState(""),[R,G]=x.useState(1),[M,S]=x.useState({status:"idle",items:[],error:null}),[C,q]=x.useState({status:"idle",items:[],error:null});x.useEffect(()=>{l||m({status:"failed",data:null,error:"Invalid attraction id"})},[l]);const L=x.useMemo(()=>{const r=W(d.data||{}),a=Number(r);if(Number.isFinite(a))return a;const u=Number(l);return Number.isFinite(u)?u:null},[d.data,l]),H=x.useCallback(r=>{if(!r)return()=>{};let a=!1;return S({status:"loading",items:[],error:null}),(async()=>{try{const f=await I.get($.gallery.list(),{params:{active:!0,target_type:"attraction",target_ref_id:r,limit:12}});if(a)return;const v=Array.isArray(f==null?void 0:f.data)?f.data:Array.isArray(f)?f:[];S({status:"succeeded",items:v,error:null})}catch(f){if(a)return;S({status:"failed",items:[],error:(f==null?void 0:f.message)||"Failed to load gallery"})}})(),()=>{a=!0}},[]);x.useEffect(()=>L?H(L):(S({status:"idle",items:[],error:null}),()=>{}),[L,H]),x.useEffect(()=>{if(!l)return;m({status:"loading",data:null,error:null});const r=new AbortController;return(async()=>{try{const a=await I.get($.attractions.byId(l),{signal:r.signal}),u=(a==null?void 0:a.attraction)||a||null;m({status:"succeeded",data:u,error:null})}catch(a){if(a!=null&&a.canceled)return;m({status:"failed",data:null,error:(a==null?void 0:a.message)||"Failed to load attraction"})}})(),()=>r.abort()},[l]);const X=x.useCallback(async()=>{if(!l||!o)return;p(a=>({...a,status:"loading",error:null,items:[]}));const r=new AbortController;try{const a=await I.get($.slots.list(),{params:{attraction_id:l,date:z(o)},signal:r.signal}),u=Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[];p({status:"succeeded",items:u,error:null});const f=u.find(v=>mt(v,o))||u[0]||null;A(f?V(f,0):"")}catch(a){if(a!=null&&a.canceled)return;p({status:"failed",items:[],error:(a==null?void 0:a.message)||"Failed to load slots"})}return()=>r.abort()},[l,o]);x.useEffect(()=>{l&&o?(A(""),X()):p({status:"idle",items:[],error:null})},[l,o,X]),x.useEffect(()=>{if(!l||C.status==="loading")return;let r=!1;return q(a=>({...a,status:"loading",error:null})),(async()=>{try{const a=await I.get($.offers.list(),{params:{active:!0,target_type:"attraction",target_id:l}});if(r)return;const u=Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[];q({status:"succeeded",items:u,error:null})}catch(a){if(r)return;q({status:"failed",items:[],error:(a==null?void 0:a.message)||"Failed to load offers"})}})(),()=>{r=!0}},[l,C.status]);const s=d.data,B=(s==null?void 0:s.name)||(s==null?void 0:s.title)||"Attraction",xt=`https://picsum.photos/seed/attr${l}/1920/800`,ft=`https://picsum.photos/seed/attr${l}/800/600`,[pt,gt]=x.useState(typeof window<"u"?window.innerWidth>=1024:!1);x.useEffect(()=>{if(typeof window>"u")return;const r=()=>gt(window.innerWidth>=1024);return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const ht=U((s==null?void 0:s.desktop_image_url)||(s==null?void 0:s.hero_image)||(s==null?void 0:s.banner_image)||(s==null?void 0:s.image_web)||(s==null?void 0:s.image_url)||s,xt),yt=U((s==null?void 0:s.mobile_image)||(s==null?void 0:s.image_mobile)||(s==null?void 0:s.image_url)||s,ft),Z=pt?ht:yt,bt=M.items.length>0,n=x.useMemo(()=>{for(let r=0;r<b.items.length;r+=1){const a=b.items[r];if(V(a,r)===y)return a}return null},[b.items,y]),P=Number(Pt(s)||0),O=Number(St(s)||P),K=(n==null?void 0:n.pricing)||{},tt=(n==null?void 0:n.offer)||null,jt=n?Bt(n,O):O,Nt=n?it(n,P):P,g=Number(K.base_price??jt??0),k=Number(K.final_price??Nt??0),D=!!tt||g>0&&k>0&&k<g&&K.final_price!=null,_t=D&&g>0?Math.round((g-k)/g*100):0,T=Math.max(1,Number(R)||1),_=x.useMemo(()=>{if(!n||!s||!C.items.length||D)return null;const r=k||g||0;if(!r)return null;const a=W(s);return zt(C.items,{targetType:"attraction",targetId:a,date:o,slot:n,basePrice:r})},[s,n,C.items,k,g,o,D]),N=D?k||g:_?_.price:k,j=D?tt:(_==null?void 0:_.offer)||null,et=(j==null?void 0:j.description)||"",vt=D?_t:_&&g>0?Math.round((g-N)/g*100):Tt(s)||0,st=g>0&&N>0&&N<g,wt=Number(N||0)*T,Mt=()=>{var v;if(!s||!o||!n||!R)return;const r=(n==null?void 0:n.id)??(n==null?void 0:n._id)??(n==null?void 0:n.slot_id);if(!r)return;const a=W(s),u=T;c(Ct({itemType:"attraction",attractionId:a,attraction:s,date:z(o),booking_date:z(o),booking_time:(n==null?void 0:n.start_time)||(n==null?void 0:n.startTime)||(n==null?void 0:n.slot_start_time)||null,slotId:r,slot:n,qty:u,unitPrice:Number(N??(n==null?void 0:n.price)??g),title:(s==null?void 0:s.title)||(s==null?void 0:s.name)||`Attraction #${a}`,slotLabel:ct(n),dateLabel:w(o).format("DD MMM YYYY"),meta:{title:(s==null?void 0:s.title)||(s==null?void 0:s.name)||`Attraction #${a}`,start_time:n==null?void 0:n.start_time,end_time:n==null?void 0:n.end_time,capacity:n==null?void 0:n.capacity,available:n==null?void 0:n.available},offer_id:j==null?void 0:j.offer_id,offer_rule_id:(j==null?void 0:j.rule_id)||((v=_==null?void 0:_.rule)==null?void 0:v.rule_id)})),c(Lt(1));const f=new URLSearchParams({type:"attraction",attraction_id:String(a),date:z(o),slot:y,qty:String(u)});i(`/booking?${f.toString()}`)};if(d.status==="loading"&&!s)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center bg-white",children:e.jsx(Q,{})});if(d.status==="failed")return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center bg-white px-4",children:e.jsx("div",{className:"max-w-lg w-full",children:e.jsx(E,{message:d.error||"Attraction not found"})})});if(!s)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center bg-white px-4",children:e.jsx("div",{className:"max-w-lg w-full",children:e.jsx(E,{message:"Attraction not found"})})});const F=(s==null?void 0:s.short_description)||(s==null?void 0:s.subtitle)||"",rt=n,at=rt&&N?N*T:null;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-[#e0f2fe] via-[#bae6fd] to-white font-sans",children:[e.jsx("section",{className:"relative h-[42vh] md:h-[56vh] bg-gray-200",children:d.status==="loading"?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Q,{})}):Z?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Z,alt:B,loading:"lazy",className:"w-full h-full object-cover",draggable:"false"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"}),e.jsx("div",{className:"absolute bottom-6 left-0 right-0 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("h1",{className:"text-3xl md:text-5xl font-bold text-white drop-shadow",children:B}),F?e.jsx("p",{className:"text-gray-200 text-sm md:text-base max-w-2xl mt-2",children:F}):null]})})]}):null}),e.jsx("section",{className:"bg-white/90 backdrop-blur border-b border-gray-100 shadow-sm",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 py-4 md:py-5",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3 md:gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500 mb-1",children:"Book this experience"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Choose your date, time slot & tickets to continue to checkout."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 md:gap-4 md:flex-none",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 sm:px-4 sm:py-2.5",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Date"}),e.jsx("input",{type:"date",className:"bg-transparent border-none outline-none text-sm font-medium text-gray-900",min:lt(),value:o,onChange:r=>h(r.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 sm:px-4 sm:py-2.5 min-w-[190px]",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Slot"}),b.status==="loading"?e.jsx("span",{className:"text-xs text-gray-500",children:"Loading…"}):e.jsx("select",{className:"flex-1 bg-transparent border-none outline-none text-sm font-medium text-gray-900 truncate",value:y,onChange:r=>A(r.target.value),disabled:b.status==="loading"||!b.items.length,children:b.items.length?e.jsxs(e.Fragment,{children:[!y&&e.jsx("option",{value:"",children:"Select slot"}),b.items.filter(r=>mt(r,o)).map((r,a)=>{const u=V(r,a),f=(r==null?void 0:r.available)===0||(r==null?void 0:r.capacity)===0,v=it(r,P)||P||0;return e.jsxs("option",{value:u,disabled:f,children:[ct(r),v?` • ${Y(v)}`:"",f?" — Unavailable":""]},u)})]}):e.jsx("option",{children:"No slots"})})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 sm:px-4 sm:py-2.5",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Qty"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"w-7 h-7 text-sm rounded-full border border-gray-300 flex items-center justify-center",onClick:()=>G(r=>Math.max(1,Number(r||1)-1)),children:"-"}),e.jsx("input",{type:"number",min:1,value:R,onChange:r=>G(Math.max(1,Number(r.target.value)||1)),className:"w-12 bg-transparent border-none text-center text-sm font-semibold outline-none"}),e.jsx("button",{type:"button",className:"w-7 h-7 text-sm rounded-full border border-gray-300 flex items-center justify-center",onClick:()=>G(r=>Math.max(1,Number(r||1)+1)),children:"+"})]})]}),e.jsx("button",{type:"button",className:"w-full sm:w-auto inline-flex items-center justify-center rounded-xl bg-blue-600 text-white px-6 py-2.5 text-sm font-semibold shadow-md hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed",disabled:!rt||!N,onClick:Mt,children:at?e.jsxs(e.Fragment,{children:["Book Now •"," ",e.jsx("span",{className:"ml-1 rupee",children:Y(at)})]}):"Book Now"})]})]})})}),e.jsxs("section",{className:"max-w-6xl mx-auto px-4 py-8 md:py-12 grid grid-cols-1 lg:grid-cols-3 gap-10 md:gap-12",children:[e.jsx("div",{className:"lg:col-span-2 space-y-8",children:d.status==="failed"?e.jsx(E,{message:d.error}):e.jsxs(e.Fragment,{children:[F?e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-5 md:p-6",children:e.jsx("p",{className:"text-gray-700 text-base md:text-lg",children:F})}):null,s!=null&&s.description?e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-5 md:p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-3",children:"About this attraction"}),e.jsx("div",{className:"prose prose-sm md:prose max-w-none text-gray-700 leading-relaxed",style:{textAlign:"left"},dangerouslySetInnerHTML:{__html:s.description}})]}):null,M.status==="loading"&&!M.items.length?e.jsx("div",{className:"mt-4",children:e.jsx(Q,{})}):null,M.status==="failed"?e.jsx("div",{className:"mt-4",children:e.jsx(E,{message:M.error,onRetry:()=>L&&H(L)})}):null,bt&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-5 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Gallery"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["#",((nt=M.items[0])==null?void 0:nt.target_name)||B]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3",children:M.items.map(r=>{const a=String(r.media_type||"").toLowerCase()==="video",u=a?r.url:U(r);return u?e.jsxs("figure",{className:"relative rounded-xl overflow-hidden border shadow-sm bg-white",children:[a?e.jsx("video",{className:"w-full h-48 object-cover",src:u,controls:!0,preload:"metadata",poster:U(r.thumbnail)}):e.jsx("img",{src:u,alt:r.title||B,className:"w-full h-48 object-cover",loading:"lazy"}),(r.title||r.description)&&e.jsxs("figcaption",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 text-xs text-white",children:[r.title?e.jsx("div",{className:"font-medium text-sm",children:r.title}):null,r.description?e.jsx("div",{className:"opacity-80 mt-1",children:r.description}):null]})]},`linked-media-${r.gallery_item_id}`):null})})]})]})}),e.jsx("aside",{className:"lg:col-span-1",children:e.jsxs("div",{className:"rounded-3xl border shadow-lg bg-white p-6 sticky top-24 space-y-6",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1 flex-1",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] uppercase tracking-wide text-gray-500 font-semibold",children:"Base price"}),e.jsx("div",{className:"text-lg font-semibold text-gray-900 rupee",children:Y(g||N||0)})]}),st?e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] uppercase tracking-wide text-gray-500",children:"Offer price"}),e.jsx("div",{className:"text-2xl font-bold text-emerald-600 rupee",children:Y(N||0)}),et?e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:et}):null]}):e.jsx("p",{className:"text-xs text-gray-500",children:"Per person • taxes included"}),j?e.jsxs("span",{className:"mt-1 text-xs font-semibold text-emerald-600 flex items-center gap-1",children:[e.jsxs("span",{children:[j.rule_type==="happy_hour"?"Happy Hour":"Offer"," ","applied:"]}),e.jsx("span",{children:j.title||"Special offer"})]}):null]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"per ticket"}),st&&e.jsxs("div",{className:"text-xs font-semibold text-emerald-600",children:["Save ",vt,"%"]})]})]}),e.jsxs("div",{className:"mt-3 rounded-2xl border bg-gray-50 px-3 py-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between text-gray-600",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{className:"rupee",children:[T," × ",Y(N||0)]})]}),e.jsxs("div",{className:"mt-1 flex items-center justify-between text-gray-900 font-semibold",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"rupee",children:Y(wt||0)})]})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsx("p",{className:"text-gray-600",children:"Slots and pricing may vary by date and time. Use the booking bar above to choose your preferred session."}),e.jsx(Yt,{to:"/attractions",className:"inline-flex items-center justify-center rounded-full border border-blue-100 text-blue-600 px-5 py-2.5 text-sm font-medium hover:bg-blue-50",children:"Explore other attractions"})]}),e.jsx("p",{className:"text-[11px] text-gray-400 text-center",children:"We’ll add this to your cart so you can add more attractions before checkout."})]})})]})]})}export{Vt as default};
