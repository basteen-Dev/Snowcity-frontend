import{D,C as M,R as d,j as e}from"./index-C5Mz9dTM.js";import{a as g,A as v}from"./AdminApp-C7IcGGGV.js";import{I as O}from"./ImageUploader-DAvc2Cys.js";import{u as $}from"./useCatalogTargets-DhWrb5ei.js";import"./createLucideIcon-DQ6FqzLt.js";import"./file-text-CQ7rExmv.js";import"./ticket-C3bgGsni.js";import"./media-DDlhmRHE.js";function Q(){var I,S,U;const{id:x}=D(),f=M(),m=!!x,[n,b]=d.useState({status:m?"loading":"idle",error:null,form:{media_type:"image",url:"",title:"",description:"",active:!0,target_type:"none",target_ref_id:null}});d.useEffect(()=>{m&&(async()=>{try{const t=await g.get(v.galleryById(x)),a=(t==null?void 0:t.gallery)||t||{};b(l=>({...l,status:"idle",form:{media_type:a.media_type||"image",url:a.url||"",title:a.title||"",description:a.description||"",active:a.active!==void 0?!!a.active:!0,target_type:a.target_type||"none",target_ref_id:a.target_ref_id||null}}))}catch(t){b(a=>({...a,status:"failed",error:t}))}})()},[x,m]);const i=t=>b(a=>({...a,form:{...a.form,...t}})),{attractions:N=[],combos:_=[],status:w}=$(),L=d.useMemo(()=>({attraction:N.map(t=>({value:t.attraction_id||t.id,label:t.title||t.name||`Attraction #${t.attraction_id||t.id}`})),combo:_.map(t=>({value:t.combo_id||t.id,label:t.title||t.name||`Combo #${t.combo_id||t.id}`}))}),[N,_]),A=async t=>{t.preventDefault();try{const{media_type:a,url:l,title:o,description:s,active:y,target_type:h,target_ref_id:k}=n.form;if(!a||!l)throw new Error("Media type and URL are required");const R={media_type:a,url:l,title:o,description:s,active:y,target_type:h,target_ref_id:h==="none"?null:k||null};m?await g.put(v.galleryById(x),R):await g.post(v.gallery(),R),f("/admin/catalog/gallery")}catch(a){b(l=>({...l,error:a}))}},B="/api/admin/uploads",[c,j]=d.useState([]),[C,E]=d.useState([]),[p,u]=d.useState({uploading:!1,progress:0,error:null});d.useEffect(()=>{const t=(c||[]).map(a=>({name:a.name,url:URL.createObjectURL(a),size:a.size,type:a.type}));return E(t),()=>t.forEach(a=>URL.revokeObjectURL(a.url))},[c]);const P=t=>{const a=Array.from(t.target.files||[]).filter(l=>l&&l.type&&l.type.startsWith("image/"));j(a),u({uploading:!1,progress:0,error:null})},F=t=>j(a=>a.filter((l,o)=>o!==t)),G=async()=>{var l;if(!c.length)return;u({uploading:!0,progress:0,error:null});const t=c.length;let a=0;try{for(const o of c){const s=await g.upload(B,o),y=(s==null?void 0:s.url)||(s==null?void 0:s.secure_url)||(s==null?void 0:s.location)||((l=s==null?void 0:s.data)==null?void 0:l.url)||"";if(!y)throw new Error("Upload response missing URL for "+(o.name||"file"));const h={media_type:"image",url:y,title:o.name,description:"",active:!0,target_type:n.form.target_type||"none",target_ref_id:n.form.target_type==="none"?null:n.form.target_ref_id||null};await g.post(v.gallery(),h),a+=1,u(k=>({...k,progress:Math.round(a/t*100)}))}u(o=>({...o,uploading:!1,progress:100})),f("/admin/catalog/gallery")}catch(o){u({uploading:!1,progress:Math.round(a/t*100),error:o})}};if(n.status==="loading")return e.jsx("div",{children:"Loading…"});if(n.status==="failed")return e.jsx("div",{className:"text-red-600",children:((I=n.error)==null?void 0:I.message)||"Failed to load"});const r=n.form;return e.jsxs("form",{onSubmit:A,className:"max-w-2xl bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl p-4",children:[e.jsxs("h1",{className:"text-xl font-semibold mb-4",children:[m?"Edit":"New"," Gallery Item"]}),n.error?e.jsx("div",{className:"mb-3 text-sm text-red-600",children:((S=n.error)==null?void 0:S.message)||"Save failed"}):null,e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Gallery Category"}),e.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_type,onChange:t=>i({target_type:t.target.value,target_ref_id:null}),children:[e.jsx("option",{value:"none",children:"Common Gallery (General)"}),e.jsx("option",{value:"attraction",children:"Attraction Gallery"}),e.jsx("option",{value:"combo",children:"Combo Gallery"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r.target_type==="none"?"Images will appear in general gallery":r.target_type==="attraction"?"Images will appear only on selected attraction page":"Images will appear only on selected combo page"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Media Type"}),e.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.media_type,onChange:t=>i({media_type:t.target.value}),children:[e.jsx("option",{value:"image",children:"Image"}),e.jsx("option",{value:"video",children:"Video"})]})]}),e.jsx("div",{className:"md:col-span-2",children:r.media_type==="image"?e.jsxs("div",{children:[e.jsx(O,{label:"Image",value:r.url,onChange:t=>i({url:t}),folder:"gallery",requiredPerm:"uploads:write"}),e.jsxs("div",{className:"mt-4 border-t pt-4",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Bulk Upload Images"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:P,className:"text-sm"}),C.length?e.jsx("div",{className:"mt-3 grid grid-cols-3 md:grid-cols-6 gap-2",children:C.map((t,a)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:t.url,alt:t.name,className:"w-full h-24 object-cover rounded-md border"}),e.jsx("button",{type:"button",onClick:()=>F(a),className:"absolute top-1 right-1 bg-white/80 text-xs rounded-full px-2 py-0.5",children:"Remove"})]},t.url))}):e.jsx("div",{className:"mt-2 text-sm text-gray-500",children:"No files selected for bulk upload."}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:G,className:"rounded-md bg-blue-600 text-white px-3 py-1.5 text-sm",disabled:p.uploading||!c.length,children:p.uploading?`Uploading (${p.progress}%)`:"Upload All"}),e.jsx("button",{type:"button",onClick:()=>{j([]),u({uploading:!1,progress:0,error:null})},className:"rounded-md border px-3 py-1.5 text-sm",children:"Clear"}),p.error?e.jsx("div",{className:"text-sm text-red-600",children:((U=p.error)==null?void 0:U.message)||"Upload failed"}):null]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Video URL"}),e.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",placeholder:"https://…",value:r.url,onChange:t=>i({url:t.target.value})})]})}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Title"}),e.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.title,onChange:t=>i({title:t.target.value})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Description"}),e.jsx("textarea",{rows:3,className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.description,onChange:t=>i({description:t.target.value})})]}),r.target_type!=="none"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:r.target_type==="attraction"?"Select attraction":"Select combo"}),e.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_ref_id||"",onChange:t=>i({target_ref_id:t.target.value?Number(t.target.value):null}),disabled:w==="loading",children:[e.jsx("option",{value:"",children:w==="loading"?"Loading…":"Select an option"}),(L[r.target_type]||[]).map(t=>e.jsx("option",{value:t.value||"",children:t.label},`${r.target_type}-${t.value}`))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r.target_type==="attraction"?"Images will appear only on selected attraction page":"Images will appear only on selected combo page"})]}):null,e.jsxs("div",{className:"flex items-center gap-2 md:col-span-2",children:[e.jsx("input",{id:"active",type:"checkbox",checked:!!r.active,onChange:t=>i({active:t.target.checked})}),e.jsx("label",{htmlFor:"active",className:"text-sm text-gray-700 dark:text-neutral-200",children:"Active"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Preview"}),e.jsx("div",{className:"w-full h-48 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:r.url?r.media_type==="video"?e.jsx("video",{className:"w-full h-full object-cover",src:r.url,muted:!0,controls:!0,preload:"metadata"}):e.jsx("img",{className:"w-full h-full object-cover",src:r.url,alt:r.title||"Preview"}):e.jsx("div",{className:"text-sm text-gray-500",children:"No media selected"})})]})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{type:"submit",className:"rounded-md bg-gray-900 text-white px-4 py-2 text-sm",children:"Save"}),e.jsx("button",{type:"button",className:"rounded-md border px-4 py-2 text-sm",onClick:()=>f(-1),children:"Cancel"})]})]})}export{Q as default};
