import{A as U,m as J,R as n,D as g,j as t}from"./index-CmreT6x1.js";import{a as S}from"./AdminApp-BV7zANWg.js";import"./createLucideIcon-CgZNF2TE.js";import"./file-text-ButRzfWA.js";import"./newspaper-yOb_4zvd.js";import"./ticket-hq6RMmhb.js";import"./chevron-down-bqKWLlrR.js";const f=s=>{if(!s)return"";const[r,x]=s.split(":"),i=parseInt(r,10);if(Number.isNaN(i))return s;const a=i>=12?"PM":"AM";return`${i%12||12}:${x} ${a}`},K=s=>s?new Date(s).toLocaleString():"N/A",D=s=>{if(s){if(/^\d{2}:\d{2}:\d{2}$/.test(s))return s;if(/^\d{1,2}:\d{2}$/.test(s)){const r=s.split(":");return`${r[0].padStart(2,"0")}:${r[1]}:00`}if(/\s/.test(s)){const r=new Date(`1970-01-01T${s}`);if(!Number.isNaN(r.getTime())){const x=String(r.getHours()).padStart(2,"0"),i=String(r.getMinutes()).padStart(2,"0"),a=String(r.getSeconds()).padStart(2,"0");return`${x}:${i}:${a}`}}}},F=(s,r)=>!s||!r?!1:s.slice(0,5)===r.slice(0,5),V=(s={},r={})=>{if(!s||!r||s.booking_date&&r.start_date&&s.booking_date!==r.start_date)return!1;const x=D(r.start_time),i=D(r.end_time),a=s.slot_start_time||s.booking_time,h=s.slot_end_time||null,c=x&&i?F(x,a||"")&&(!i||F(i,h||i)):!0;return s.combo_slot_id&&r.combo_slot_id&&String(s.combo_slot_id)===String(r.combo_slot_id)||c},W=s=>s?s.item_type==="Combo"&&!s.parent_booking_id?t.jsx("span",{className:"inline-flex items-center rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-medium text-indigo-700",children:"Combo parent"}):s.parent_booking_id?t.jsx("span",{className:"inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700",children:"Combo child"}):null:null;function re(){const s=U(),[r]=J(),[x,i]=n.useState([]),[a,h]=n.useState(""),[c,w]=n.useState(g().format("YYYY-MM-DD")),[p,A]=n.useState(g().add(1,"year").format("YYYY-MM-DD")),[I,y]=n.useState([]),[$,Y]=n.useState(!1),[E,b]=n.useState(""),[m,P]=n.useState(null),[C,k]=n.useState([]),[u,q]=n.useState([]),[N,j]=n.useState(0);n.useEffect(()=>{(async()=>{try{const e=await S.get("/api/admin/combos",{active:!0}),o=Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e)?e:[];i(o);const d=r.get("combo_id");d&&h(d)}catch{}})()},[r]);async function M(){var e,o,d;if(console.log("ðŸ” ComboSlotList load() called"),console.log("ðŸ“‹ comboId:",a),console.log("ðŸ“‹ comboId type:",typeof a),console.log("ðŸ“‹ startDate:",c),console.log("ðŸ“‹ endDate:",p),!a||a==="undefined"||a==="null"||a===""||isNaN(Number(a))){console.log("âŒ Invalid or missing comboId:",a),y([]),b("Please select a combo to view slots.");return}console.log("âœ… comboId is valid, making API call");try{Y(!0),b("");const l=await S.get("/api/admin/combo-slots",{params:{start_date:c||null,end_date:p||null,combo_id:Number(a)}});console.log("âœ… API call successful:",l);const v=Array.isArray(l==null?void 0:l.data)?l.data:Array.isArray(l)?l:[];y(v);const B=Array.from(new Set(v.map(Q=>Q.start_date))).sort();q(B);const R=B.indexOf(c);j(R>=0?R:0)}catch(l){console.error("âŒ Failed to load combo slots:",l),console.error("âŒ Error response:",l.response),console.error("âŒ Error status:",(e=l.response)==null?void 0:e.status),console.error("âŒ Error data:",(o=l.response)==null?void 0:o.data),((d=l.response)==null?void 0:d.status)===400?b("Invalid combo ID. Please select a valid combo."):b(l.message||"Failed to load")}finally{Y(!1)}}n.useEffect(()=>{console.log("ðŸ”„ ComboSlotList useEffect triggered"),console.log("ðŸ“‹ Current comboId:",a),console.log("ðŸ“‹ Dependencies changed:",{comboId:a,startDate:c,endDate:p}),a&&a!=="undefined"&&a!=="null"&&a!==""&&!isNaN(Number(a))?(console.log("âœ… comboId is valid, calling load()"),M()):(console.log("âŒ No valid comboId, skipping load()"),y([]),b("Please select a combo to view slots."))},[a,c,p]),n.useEffect(()=>{if(!u.length)return;const e=u.indexOf(c);e>=0&&j(e)},[c,u]);const z=()=>{if(!a||a==="undefined"||a==="null"){alert("Select a combo before extending slots.");return}const o=(p?g(p):g().add(1,"year")).add(1,"year");A(o.format("YYYY-MM-DD"))};async function H(e){if(typeof e=="string"&&e.includes("-")){alert("Dynamic slots cannot be deleted. They are generated automatically based on calendar.");return}if(window.confirm("Delete this combo slot?"))try{await S.delete(`/api/admin/combo-slots/${e}`),y(o=>o.filter(d=>d.combo_slot_id!==e))}catch(o){alert(o.message||"Delete failed")}}async function O(e){P(e);try{const o=await S.get("/api/admin/bookings",{params:{combo_id:e.combo_id,booking_date:e.start_date,combo_slot_id:e.combo_slot_id,slot_start_time:D(e.start_time),slot_end_time:D(e.end_time),limit:200}}),d=Array.isArray(o==null?void 0:o.data)?o.data:Array.isArray(o)?o:[],l=d.filter(v=>V(v,e));console.log("ðŸ” Combo slot inspector match stats:",{combo_slot_id:e.combo_slot_id,bookingCount:d.length,matchedCount:l.length}),k(l.length?l:d)}catch(o){console.error("Failed to fetch bookings:",o),k([])}}function G(){P(null),k([])}const T=e=>{const o=x.find(d=>d.combo_id===e);return o?o.title||`Combo #${e}`:`#${e}`},_=u[N],L=_?I.filter(e=>e.start_date===_):I;return t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("select",{className:"rounded-md border px-2 py-2 text-sm dark:bg-neutral-900 dark:border-neutral-700",value:a,onChange:e=>h(e.target.value),children:[t.jsx("option",{value:"",children:"All combos"}),x.map(e=>t.jsx("option",{value:e.combo_id,children:e.title||`Combo #${e.combo_id}`},e.combo_id))]}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-2 text-sm dark:bg-neutral-900 dark:border-neutral-700",value:c,onChange:e=>w(e.target.value)}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-2 text-sm dark:bg-neutral-900 dark:border-neutral-700",value:p,onChange:e=>A(e.target.value)}),t.jsx("button",{className:"px-3 py-2 rounded-md border text-sm",onClick:M,children:"Filter"}),t.jsx("button",{className:"px-3 py-2 rounded-md border text-sm",onClick:z,disabled:!a,children:"Generate Next Year"})]}),E?t.jsx("div",{className:"text-sm text-red-600",children:E}):null,t.jsx("div",{className:"rounded-lg border bg-white dark:bg-neutral-900 dark:border-neutral-800 overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Combo"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Date Range"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Time"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Capacity"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Price"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Available"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Actions"})]})}),t.jsxs("tbody",{children:[L.map(e=>t.jsxs("tr",{className:"border-t dark:border-neutral-800 hover:bg-gray-50 dark:hover:bg-neutral-800 cursor-pointer",onClick:()=>O(e),children:[t.jsx("td",{className:"px-3 py-2",children:e.combo_name||T(e.combo_id)}),t.jsxs("td",{className:"px-3 py-2",children:[e.start_date," ",e.end_date&&e.end_date!==e.start_date?`â†’ ${e.end_date}`:""]}),t.jsxs("td",{className:"px-3 py-2",children:[f(e.start_time)," â†’ ",f(e.end_time)]}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.capacity}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.price==null?"-":`â‚¹ ${Number(e.price).toLocaleString()}`}),t.jsx("td",{className:"px-3 py-2",children:e.available?"Yes":"No"}),t.jsxs("td",{className:"px-3 py-2 text-right space-x-2",children:[t.jsx("button",{className:"px-2 py-1 rounded-md border text-xs",onClick:o=>{o.stopPropagation(),s(`/admin/catalog/combo-slots/${e.combo_slot_id}`)},children:"Edit"}),t.jsx("button",{className:"px-2 py-1 rounded-md border text-xs",onClick:o=>{o.stopPropagation(),H(e.combo_slot_id)},children:"Delete"})]})]},e.combo_slot_id)),!L.length&&!$&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-6 text-center text-gray-500",colSpan:7,children:a?"No combo slots for this date":"Select a combo to view slots"})})]})]})}),u.length>1&&t.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[t.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>j(e=>Math.max(0,e-1)),disabled:N===0,children:"Prev Date"}),t.jsxs("div",{className:"text-gray-600",children:[_?g(_).format("DD MMM YYYY"):"â€”"," (",N+1," / ",u.length,")"]}),t.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>j(e=>Math.min(u.length-1,e+1)),disabled:N>=u.length-1,children:"Next Date"})]}),$?t.jsx("div",{className:"text-sm text-gray-500",children:"Loadingâ€¦"}):null,m&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white dark:bg-neutral-900 rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-auto",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Slot Details & Bookings"}),t.jsx("button",{onClick:G,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"âœ•"})]}),t.jsxs("div",{className:"bg-gray-50 dark:bg-neutral-800 p-4 rounded-lg mb-4",children:[t.jsx("h3",{className:"font-medium mb-2",children:"Slot Information"}),t.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("strong",{children:"Combo:"})," ",m.combo_name||T(m.combo_id)]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Date:"})," ",m.start_date]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Time:"})," ",f(m.start_time)," â†’ ",f(m.end_time)]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Capacity:"})," ",m.capacity]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Price:"})," ",m.price==null?"N/A":`â‚¹${Number(m.price).toLocaleString()}`]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Available:"})," ",m.available?"Yes":"No"]})]})]}),t.jsxs("div",{children:[t.jsxs("h3",{className:"font-medium mb-2",children:["Bookings (",C.length,")"]}),C.length>0?t.jsx("div",{className:"border rounded-lg overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Booking ID"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Customer"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Email"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Qty"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Status"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Amount"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Booking Time"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Booked At"})]})}),t.jsx("tbody",{children:C.map(e=>t.jsxs("tr",{className:"border-t dark:border-neutral-800",children:[t.jsxs("td",{className:"px-3 py-2",children:["#",e.booking_id,e.parent_booking_id?t.jsxs("div",{className:"text-[11px] text-gray-500",children:["Parent #",e.parent_booking_id]}):null]}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{children:e.customer_name||e.user_name||"N/A"}),t.jsx("span",{className:"text-xs text-gray-500",children:e.item_title||e.combo_title||e.attraction_title||"â€”"})]})}),t.jsx("td",{className:"px-3 py-2",children:e.customer_email||e.user_email||"N/A"}),t.jsx("td",{className:"px-3 py-2",children:e.quantity?`${e.quantity}`:"1"}),t.jsx("td",{className:"px-3 py-2",children:t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("span",{className:`px-2 py-1 text-xs rounded ${e.booking_status==="Confirmed"||e.booking_status==="Booked"?"bg-green-100 text-green-800":e.booking_status==="Pending"?"bg-yellow-100 text-yellow-800":e.booking_status==="Cancelled"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:e.booking_status||"Unknown"}),W(e)]})}),t.jsxs("td",{className:"px-3 py-2 text-right",children:["â‚¹",Number(e.total_amount||e.amount||0).toLocaleString()]}),t.jsx("td",{className:"px-3 py-2",children:f(e.slot_start_time||e.booking_time)}),t.jsx("td",{className:"px-3 py-2",children:K(e.created_at)})]},e.booking_id))})]})}):t.jsx("div",{className:"text-gray-500 text-center py-4",children:"No bookings found for this slot"})]})]})})]})}export{re as default};
