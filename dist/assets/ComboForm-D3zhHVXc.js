import{C as R,B as T,R as g,j as e}from"./index-CNdOvwUA.js";import{a as x,A as p}from"./AdminApp-sxxeVGC_.js";import{I as A}from"./ImageUploader-BR89ENI0.js";import"./createLucideIcon-D7GIchwo.js";import"./file-text-B3yKuaPb.js";import"./ticket-BYx_I3BZ.js";import"./media-Ct2xuz47.js";function z(){var f,h,v,j,N,y,k,w,C;const{id:m}=R(),b=T(),l=!!m,[o,i]=g.useState({status:l?"loading":"idle",error:null,attractions:[],form:{name:"",attraction_ids:l?[]:["",""],attraction_prices:{},total_price:0,image_url:"",desktop_image_url:"",discount_percent:0,active:!0}});g.useEffect(()=>{(async()=>{try{const a=await x.get(p.attractions()),t=Array.isArray(a==null?void 0:a.data)?a.data:Array.isArray(a)?a:[];i(s=>({...s,attractions:t}))}catch{}})()},[]),g.useEffect(()=>{l&&(async()=>{try{const a=await x.get(p.comboById(m)),t=(a==null?void 0:a.combo)||a||{};let s={name:t.name||"",attraction_ids:[],attraction_prices:{},total_price:0,image_url:t.image_url||"",desktop_image_url:t.desktop_image_url||"",discount_percent:t.discount_percent||0,active:!!t.active};t.attraction_1_id&&t.attraction_2_id?(s.attraction_ids=[t.attraction_1_id,t.attraction_2_id],s.attraction_prices={[t.attraction_1_id]:(t.combo_price||0)/2,[t.attraction_2_id]:(t.combo_price||0)/2},s.total_price=t.combo_price||0):(s.attraction_ids=t.attraction_ids||[],s.attraction_prices=t.attraction_prices||{},s.total_price=Number(t.total_price||0)),i(r=>({...r,status:"idle",form:s}))}catch(a){i(t=>({...t,status:"failed",error:a}))}})()},[m,l]);const P=async a=>{var t,s;a.preventDefault();try{const r=o.form;if(!r.name||r.name.trim()===""){alert("Please enter a combo name");return}if(!r.attraction_ids||r.attraction_ids.length<2){alert("Select at least two attractions");return}for(const d of r.attraction_ids)if(!r.attraction_prices[d]||r.attraction_prices[d]<=0){const u=o.attractions.find(B=>B.attraction_id===d);alert(`Please set a valid price for ${(u==null?void 0:u.title)||"attraction"}`);return}const n={name:r.name.trim(),attraction_ids:r.attraction_ids,attraction_prices:r.attraction_prices,total_price:Number(r.total_price||0),image_url:((t=r.image_url)==null?void 0:t.trim())||null,discount_percent:Number(r.discount_percent||0),active:!!r.active};l?await x.put(p.comboById(m),n):await x.post(p.combos(),n),b("/admin/catalog/combos")}catch(r){console.error("Combo save error:",r),console.error("Error data:",r==null?void 0:r.data),console.error("Error status:",r==null?void 0:r.status),console.error("Error details:",(s=r==null?void 0:r.data)==null?void 0:s.details),i(n=>({...n,error:r}))}};if(o.status==="loading")return e.jsx("div",{children:"Loading…"});if(o.status==="failed")return e.jsx("div",{className:"text-red-600",children:((f=o.error)==null?void 0:f.message)||"Failed to load"});if(o.error&&o.error!=="Failed to load")return e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Error"}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:[e.jsx("div",{className:"text-red-800 font-semibold mb-2",children:((v=(h=o.error)==null?void 0:h.data)==null?void 0:v.error)||"Save Failed"}),e.jsx("div",{className:"text-red-700 text-sm mb-2",children:((N=(j=o.error)==null?void 0:j.data)==null?void 0:N.message)||((y=o.error)==null?void 0:y.message)}),((w=(k=o.error)==null?void 0:k.data)==null?void 0:w.details)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-red-800 font-medium text-sm mb-1",children:"Validation Details:"}),e.jsx("ul",{className:"text-red-700 text-sm list-disc list-inside",children:o.error.data.details.map((a,t)=>e.jsxs("li",{children:[e.jsxs("strong",{children:[a.field,":"]})," ",a.message,a.value!==void 0&&e.jsxs("span",{className:"text-red-600 ml-1",children:["(value: ",JSON.stringify(a.value),")"]})]},t))})]}),e.jsx("button",{onClick:()=>i(a=>({...a,error:null})),className:"mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Dismiss"})]})]});const c=o.form,E=o.attractions||[],S=()=>{i(a=>({...a,form:{...a.form,attraction_ids:[...a.form.attraction_ids,""]}}))},F=a=>{const t=o.form.attraction_ids.filter((r,n)=>n!==a),s={...o.form.attraction_prices};delete s[o.form.attraction_ids[a]],i(r=>({...r,form:{...r.form,attraction_ids:t,attraction_prices:s}})),_(t,s)},I=(a,t)=>{const s=o.form.attraction_ids[a],r=[...o.form.attraction_ids];r[a]=t;const n={...o.form.attraction_prices};if(s&&s!==t&&delete n[s],t&&!n[t]){const d=o.attractions.find(u=>u.attraction_id===t);n[t]=(d==null?void 0:d.price)||0}i(d=>({...d,form:{...d.form,attraction_ids:r,attraction_prices:n}})),_(r,n)},D=(a,t)=>{const s={...o.form.attraction_prices,[a]:Number(t||0)};i(r=>({...r,form:{...r.form,attraction_prices:s}})),_(o.form.attraction_ids,s)},_=(a,t)=>{const s=a.reduce((r,n)=>r+(Number(t[n])||0),0);i(r=>({...r,form:{...r.form,total_price:s}}))};return e.jsxs("form",{onSubmit:P,className:"max-w-4xl bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl p-4",children:[e.jsxs("h1",{className:"text-xl font-semibold mb-4",children:[l?"Edit":"New"," Combo"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Combo Name *"}),e.jsx("input",{type:"text",className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:c.name,onChange:a=>i(t=>({...t,form:{...t.form,name:a.target.value}})),placeholder:"Enter combo name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300",children:"Attractions *"}),e.jsx("button",{type:"button",onClick:S,className:"text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700",children:"+ Add Attraction"})]}),c.attraction_ids.length===0&&e.jsx("div",{className:"text-gray-500 text-sm mb-2",children:"No attractions selected. Add at least 2 attractions."}),c.attraction_ids.map((a,t)=>e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsxs("select",{className:"flex-1 rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:a,onChange:s=>I(t,s.target.value),children:[e.jsx("option",{value:"",children:"— Select attraction —"}),E.map(s=>e.jsx("option",{value:s.attraction_id,disabled:c.attraction_ids.includes(String(s.attraction_id))&&String(s.attraction_id)!==a,children:s.title},s.attraction_id))]}),a&&e.jsx("input",{type:"number",className:"w-32 rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:c.attraction_prices[a]||"",onChange:s=>D(a,s.target.value),placeholder:"Price",min:"0",step:"0.01"}),c.attraction_ids.length>2&&e.jsx("button",{type:"button",onClick:()=>F(t),className:"px-2 py-1 text-red-600 border border-red-300 rounded-md hover:bg-red-50",children:"Remove"})]},t)),c.attraction_ids.length>0&&c.attraction_ids.length<2&&e.jsx("div",{className:"text-orange-600 text-sm mt-1",children:"Please select at least 2 attractions"})]}),e.jsxs("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-neutral-800 rounded-md",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-neutral-300",children:"Total Combo Price"}),e.jsxs("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:["₹",Number(c.total_price||0).toFixed(2)]}),c.attraction_ids.length>0&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-neutral-400 mt-1",children:["Based on ",c.attraction_ids.length," attraction(s)"]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(A,{label:"Combo Image",value:c.image_url,onChange:a=>i(t=>({...t,form:{...t.form,image_url:a}})),folder:"combos"})}),e.jsx("div",{className:"mb-4",children:e.jsx(A,{label:"Desktop Image (optional)",value:c.desktop_image_url,onChange:a=>i(t=>({...t,form:{...t.form,desktop_image_url:a}})),folder:"combos"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Discount %"}),e.jsx("input",{type:"number",className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:c.discount_percent,onChange:a=>i(t=>({...t,form:{...t.form,discount_percent:Number(a.target.value||0)}})),min:"0",max:"100"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"active",type:"checkbox",checked:!!c.active,onChange:a=>i(t=>({...t,form:{...t.form,active:a.target.checked}}))}),e.jsx("label",{htmlFor:"active",className:"text-sm text-gray-700 dark:text-neutral-200",children:"Active"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Override Total Price (optional)"}),e.jsx("input",{type:"number",className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:c.total_price,onChange:a=>i(t=>({...t,form:{...t.form,total_price:Number(a.target.value||0)}})),min:"0",step:"0.01"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-neutral-400 mt-1",children:"Automatically sums attraction prices; adjust if needed."})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{type:"submit",className:"rounded-md bg-gray-900 text-white px-4 py-2 text-sm",children:"Save"}),l&&e.jsx("button",{type:"button",className:"rounded-md bg-blue-600 text-white px-4 py-2 text-sm hover:bg-blue-700",onClick:()=>b(`/admin/catalog/combo-slots?combo_id=${m}`),children:"View Slots"}),e.jsx("button",{type:"button",className:"rounded-md border px-4 py-2 text-sm",onClick:()=>b(-1),children:"Cancel"})]}),o.error?e.jsx("div",{className:"mt-2 text-sm text-red-600",children:((C=o.error)==null?void 0:C.message)||"Error"}):null]})}export{z as default};
