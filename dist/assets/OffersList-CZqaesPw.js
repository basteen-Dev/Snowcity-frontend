import{A as P,R as y,j as t}from"./index-DpUnVvi7.js";import{a as u,A as p}from"./AdminApp-DElutmvv.js";import{A as R}from"./AdminTable-C9C_doBs.js";import"./createLucideIcon-DlloiUI2.js";import"./file-text-BcxeLTgw.js";import"./users-Dj4zQjFo.js";import"./newspaper-D6LH_a5a.js";import"./ticket-DJwTfedz.js";import"./chevron-down-BM4ufvPU.js";function E(){var v,N;const h=P(),[c,d]=y.useState({status:"idle",items:[],error:null,q:"",active:"",page:1,limit:20,meta:null}),[n,x]=y.useState({open:!1,status:"idle",offer:null,slots:[],error:null}),m=async(e=1)=>{d(s=>({...s,status:"loading",error:null,page:e}));try{const s=await u.get(p.offers(),{params:{q:c.q||void 0,active:c.active||void 0,page:e,limit:c.limit}}),l=Array.isArray(s==null?void 0:s.data)?s.data:Array.isArray(s)?s:[];d(a=>({...a,status:"succeeded",items:l,meta:(s==null?void 0:s.meta)||null,page:e}))}catch(s){d(l=>({...l,status:"failed",error:s}))}},k=async(e,s)=>{var a;(a=s==null?void 0:s.stopPropagation)==null||a.call(s);const l=e.offer_id||e.id;x({open:!0,status:"loading",offer:e,slots:[],error:null});try{const r=await u.get(`${p.offers()}/${l}/slots`,{params:{limit:1e3}}),i=Array.isArray(r==null?void 0:r.slots)?r.slots:[];x({open:!0,status:"succeeded",offer:(r==null?void 0:r.offer)||e,slots:i,error:null})}catch(r){x(i=>({...i,status:"failed",error:r}))}},A=()=>x({open:!1,status:"idle",offer:null,slots:[],error:null});y.useEffect(()=>{m(1)},[]);const C=async(e,s)=>{var l;(l=s==null?void 0:s.stopPropagation)==null||l.call(s);try{const a=e.offer_id||e.id;await u.put(`${p.offers()}/${a}`,{active:!e.active}),d(r=>({...r,items:r.items.map(i=>(i.offer_id||i.id)===a?{...i,active:!e.active}:i)}))}catch(a){alert((a==null?void 0:a.message)||"Failed to update")}},S=async(e,s)=>{var l;if((l=s==null?void 0:s.stopPropagation)==null||l.call(s),!!window.confirm(`Delete offer "${e.title}"? This cannot be undone.`))try{const a=e.offer_id||e.id;await u.delete(`${p.offers()}/${a}`),d(r=>({...r,items:r.items.filter(i=>(i.offer_id||i.id)!==a)}))}catch(a){alert((a==null?void 0:a.message)||"Delete failed")}},o=c.meta||{},g=c.page>1,j=o.page?o.page<(o.totalPages||o.total_pages||1):!1;return t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h1",{className:"text-xl font-semibold",children:"Offers"}),t.jsx("button",{className:"rounded-md bg-gray-900 text-white px-3 py-2 text-sm",onClick:()=>h("/admin/catalog/offers/new"),children:"New Offer"})]}),t.jsxs("div",{className:"mb-3 grid grid-cols-1 md:grid-cols-4 gap-2",children:[t.jsx("input",{className:"rounded-md border px-3 py-2",placeholder:"Search title",value:c.q,onChange:e=>d(s=>({...s,q:e.target.value}))}),t.jsxs("select",{className:"rounded-md border px-3 py-2",value:c.active,onChange:e=>d(s=>({...s,active:e.target.value})),children:[t.jsx("option",{value:"",children:"Active: All"}),t.jsx("option",{value:"true",children:"Active"}),t.jsx("option",{value:"false",children:"Inactive"})]}),t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>m(1),children:"Filter"})]}),t.jsx(R,{keyField:"offer_id",columns:[{key:"title",title:"Title"},{key:"discount_summary",title:"Discount",render:e=>{if((e.rule_type||"").toLowerCase()==="buy_x_get_y"){const a=Array.isArray(e.rules)&&e.rules[0]?e.rules[0]:null;if(!a)return"Buy X get Y";const r=a.buy_qty||1,i=a.get_qty||1,T=a.get_target_type||"attraction",b=a.get_target_id||"",_=a.get_discount_type||"",$=a.get_discount_value||"",f=T+(b?` #${b}`:"");return _?_==="amount"?`Buy ${r} get ${i} ${f} (₹${$})`:`Buy ${r} get ${i} ${f} (${$}%)`:`Buy ${r} get ${i} ${f} (Free)`}const s=(e.discount_type||"percent").toLowerCase(),l=Number(e.discount_value??e.discount_percent??0);return l?s==="amount"?`₹${l}`:`${l}%`:"—"}},{key:"rule_type",title:"Rule"},{key:"rule_count",title:"Rules",render:e=>Number(e.rule_count??0)},{key:"valid_from",title:"From"},{key:"valid_to",title:"To"},{key:"active",title:"Active",render:e=>String(e==null?void 0:e.active)},{key:"__actions",title:"Actions",render:e=>t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx("button",{className:`rounded-md px-2 py-1 text-xs ${e.active?"border text-red-600":"bg-blue-600 text-white"}`,onClick:s=>C(e,s),children:e.active?"Deactivate":"Activate"}),t.jsx("button",{className:"rounded-md border px-2 py-1 text-xs",onClick:s=>k(e,s),children:"View Slots"}),t.jsx("button",{className:"rounded-md border px-2 py-1 text-xs text-red-600",onClick:s=>S(e,s),children:"Delete"})]})}],rows:c.items,onRowClick:e=>h(`/admin/catalog/offers/${e.offer_id||e.id}`),empty:c.status==="loading"?"Loading…":"No offers found"}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>g&&m(c.page-1),disabled:!g||c.status==="loading",children:"Prev"}),t.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",o.page||c.page]}),t.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>j&&m(c.page+1),disabled:!j||c.status==="loading",children:"Next"})]}),n.open&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:t.jsxs("div",{className:"bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-auto",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b dark:border-neutral-800",children:[t.jsxs("div",{children:[t.jsxs("h2",{className:"text-lg font-semibold",children:["Offer Slots – ",(v=n.offer)==null?void 0:v.title]}),t.jsx("p",{className:"text-xs text-gray-500",children:"Showing slots matched by current rules"})]}),t.jsx("button",{className:"text-sm text-gray-500 hover:text-gray-800",onClick:A,children:"Close"})]}),t.jsxs("div",{className:"p-4 space-y-4",children:[n.status==="loading"&&t.jsx("div",{className:"text-sm text-gray-500",children:"Loading slots…"}),n.status==="failed"&&t.jsx("div",{className:"text-sm text-red-600",children:((N=n.error)==null?void 0:N.message)||"Failed to load slots"}),n.status==="succeeded"&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"text-sm text-gray-600",children:[n.slots.length," slots matched"]}),t.jsx("div",{className:"overflow-auto border rounded-xl",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{className:"bg-gray-50 dark:bg-neutral-800",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left",children:"Type"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Target"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Date"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Time"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Capacity"}),t.jsx("th",{className:"px-3 py-2 text-right",children:"Price"}),t.jsx("th",{className:"px-3 py-2 text-left",children:"Rule"})]})}),t.jsxs("tbody",{children:[n.slots.map((e,s)=>{var l,a;return t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"px-3 py-2 capitalize",children:((l=e._match)==null?void 0:l.type)||"attraction"}),t.jsx("td",{className:"px-3 py-2",children:e.attraction_title||e.combo_name||e.combo_id||e.attraction_id||"—"}),t.jsxs("td",{className:"px-3 py-2",children:[e.start_date,e.end_date&&e.end_date!==e.start_date?` → ${e.end_date}`:""]}),t.jsxs("td",{className:"px-3 py-2",children:[e.start_time," – ",e.end_time]}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.capacity??"—"}),t.jsx("td",{className:"px-3 py-2 text-right",children:e.price==null?"—":`₹${Number(e.price).toLocaleString()}`}),t.jsxs("td",{className:"px-3 py-2 text-xs text-gray-500",children:["Rule #",(a=e._match)==null?void 0:a.rule_id]})]},`offer-slot-${s}`)}),!n.slots.length&&t.jsx("tr",{children:t.jsx("td",{className:"px-3 py-4 text-center text-gray-500",colSpan:7,children:"No slots matched this offer"})})]})]})})]})]})]})})]})}export{E as default};
