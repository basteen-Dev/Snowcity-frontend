import{h as U,u as h,r as x,W as C,j as e,D as E,Q as $,X as z}from"./index-Buz5vlJT.js";import{f as M}from"./formatters-CmiLqhJj.js";import{t as R}from"./media-DTTax9V0.js";import{c as p}from"./createLucideIcon-BEwYts5j.js";import{C as F,F as G}from"./file-text-CuRCFKVY.js";import{C as Y}from"./circle-check-big-kex5HByG.js";import{C as q}from"./circle-alert-C1JkuNI_.js";import{C as Q}from"./clock-B80K0lJn.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],X=p("chevron-up",W);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],J=p("credit-card",H);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]],P=p("refresh-ccw",K),V=({text:t,tone:r})=>{const i={green:"bg-green-100 text-green-700 border-green-200",red:"bg-red-100 text-red-700 border-red-200",yellow:"bg-yellow-100 text-yellow-800 border-yellow-200",gray:"bg-gray-100 text-gray-700 border-gray-200",blue:"bg-blue-100 text-blue-700 border-blue-200"};return e.jsx("span",{className:`px-2.5 py-0.5 rounded-full text-xs font-medium border ${i[r]||i.gray}`,children:t})},Z=t=>{const r=String(t||"").trim().toUpperCase();return["COMPLETED","SUCCESS","PAID","CONFIRMED"].includes(r)?{tone:"green",icon:Y,label:"Paid"}:["FAILED","DECLINED","CANCELLED","CANCELED"].includes(r)?{tone:"red",icon:q,label:"Failed"}:{tone:"yellow",icon:Q,label:"Pending"}},ee=t=>{const r=String(t||"").replace(/\D/g,"");return r.length>=10?r.slice(-10):r},y=t=>{if(!t)return"";const[r,i]=String(t).split(":");if(!r||!i)return"";const n=parseInt(r,10),g=n>=12?"PM":"AM";return`${n%12||12}:${i} ${g}`},te=(t=[])=>{if(!Array.isArray(t)||!t.length)return[];const r=new Map;t.forEach(n=>{r.set(n.booking_id,{...n,child_items:[]})}),r.forEach(n=>{n.parent_booking_id&&r.has(n.parent_booking_id)&&r.get(n.parent_booking_id).child_items.push(n)});const i=Array.from(r.values()).filter(n=>!n.parent_booking_id);return i.length?i:Array.from(r.values())},se=t=>t?String(t.item_type).toLowerCase()==="combo"?t.combo_title||t.combo_name||t.item_title||(t.combo_id?`Combo #${t.combo_id}`:"Combo"):t.item_title||t.attraction_title||"Ticket":"Ticket",ae=t=>{console.log("ðŸ” DEBUG MyBookings item data:",{booking_id:t.booking_id,slot_start_time:t.slot_start_time,slot_end_time:t.slot_end_time,start_time:t.start_time,end_time:t.end_time,slot_label:t.slot_label,booking_time:t.booking_time,full_item:t});const r=y(t.slot_start_time||t.start_time),i=y(t.slot_end_time||t.end_time);if(r&&i){const g=`${r} - ${i}`;return console.log("ðŸ” DEBUG MyBookings using start/end times:",g),g}if(r)return console.log("ðŸ” DEBUG MyBookings using start time only:",r),r;if(t.slot_label)return console.log("ðŸ” DEBUG MyBookings using slot_label:",t.slot_label),t.slot_label;const n=y(t.booking_time)||"Slot Time";return console.log("ðŸ” DEBUG MyBookings using booking_time fallback:",n),n};function ge(){const t=U(),{status:r,items:i,error:n}=h(s=>s.bookings.list),g=h(s=>s.bookings.payphi),c=h(s=>{var a;return(a=s.auth)==null?void 0:a.user}),f=x.useMemo(()=>{if(!Array.isArray(i))return[];const s=new Map;return i.forEach(a=>{const d=a.order_id||a.booking_id||a.id;s.has(d)||s.set(d,{id:d,ref:a.order_ref||a.booking_ref,date:a.created_at,status:a.payment_status,items:[],calculatedTotal:0}),s.get(d).items.push(a)}),s.forEach(a=>{a.primaryItems=te(a.items),a.primaryItems.forEach(o=>{Array.isArray(o.child_items)&&o.child_items.length&&(o.child_items=[...o.child_items].sort((m,u)=>{const b=m.slot_start_time||m.booking_time||"",l=u.slot_start_time||u.booking_time||"";return String(b).localeCompare(String(l))}))});const d=a.primaryItems.length?a.primaryItems:a.items;a.itemCount=d.length,a.calculatedTotal=d.reduce((o,m)=>o+Number(m.final_amount||m.total_amount||0),0)}),Array.from(s.values()).sort((a,d)=>new Date(d.date)-new Date(a.date))},[i]),[D,I]=x.useState(null),[S,_]=x.useState(null),[j,N]=x.useState(""),[k,v]=x.useState("");x.useEffect(()=>{t(C({page:1,limit:50}))},[t]),x.useEffect(()=>{N((c==null?void 0:c.email)||""),v((c==null?void 0:c.phone)||"")},[c]);const w=()=>t(C({page:1,limit:50})),A=async s=>{const a=(j||(c==null?void 0:c.email)||"").trim(),d=ee(k||(c==null?void 0:c.phone)||"");if(!a||!d||d.length<10){alert("Please enter a valid email and 10-digit mobile to continue.");return}try{const o=await t($({bookingId:s.id,email:a,mobile:d})).unwrap();o!=null&&o.redirectUrl?window.location.href=o.redirectUrl:alert("Payment initiation failed. Please try again.")}catch(o){alert(`Payment failed: ${o.message||"Unknown error"}`)}},T=async s=>{await t(z({bookingId:s})).unwrap(),w()};return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-[#e0f2fe] via-[#bae6fd] to-white px-4 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"My Orders"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Track your tickets and payment status"})]}),e.jsx("button",{onClick:w,disabled:r==="loading",className:"p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors",title:"Refresh List",children:e.jsx(P,{size:20,className:r==="loading"?"animate-spin":""})})]}),r==="failed"&&e.jsx("div",{className:"bg-red-50 text-red-700 p-4 rounded-lg mb-6 text-sm text-center",children:(n==null?void 0:n.message)||"Failed to load orders."}),r==="succeeded"&&f.length===0&&e.jsx("div",{className:"text-center py-12 bg-gray-50 rounded-2xl border border-dashed border-gray-300",children:e.jsx("p",{className:"text-gray-500",children:"No orders found."})}),e.jsx("div",{className:"space-y-6",children:f.map(s=>{var b;const a=Z(s.status),d=a.icon,o=D===s.id,m=S===s.id,u=a.label==="Pending";return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden transition-all hover:shadow-md",children:[e.jsxs("div",{className:"p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 cursor-pointer select-none",onClick:()=>I(o?null:s.id),children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${a.tone==="green"?"bg-green-50 text-green-600":a.tone==="red"?"bg-red-50 text-red-600":"bg-yellow-50 text-yellow-600"}`,children:e.jsx(d,{size:24})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["Order #",s.ref]}),e.jsx(V,{text:a.label,tone:a.tone})]}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:E(s.date).format("DD MMM YYYY â€¢ h:mm A")}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[s.itemCount||s.items.length," Item",(s.itemCount||s.items.length)!==1&&"s"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between md:justify-end gap-6 w-full md:w-auto",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-semibold mb-1",children:"Total"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:M(s.calculatedTotal)})]}),e.jsx("div",{className:"text-gray-400",children:o?e.jsx(X,{size:24}):e.jsx(F,{size:24})})]})]}),o&&e.jsxs("div",{className:"border-t border-gray-100 bg-gray-50/50 p-5 animate-slide-down",children:[e.jsx("h4",{className:"text-xs font-bold text-gray-500 uppercase mb-3",children:"Order Items"}),e.jsx("div",{className:"space-y-3",children:(s.primaryItems&&s.primaryItems.length?s.primaryItems:s.items).map((l,B)=>{const L=ae(l),O=Number(l.final_amount||l.total_amount||0);return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200 flex flex-col md:flex-row md:items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-800 text-base",children:se(l)}),e.jsxs("div",{className:"text-sm text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{children:E(l.booking_date).format("DD MMM")}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsx("span",{children:L}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsxs("span",{children:["Qty: ",l.quantity]})]})]}),e.jsx("div",{className:"font-bold text-gray-900",children:M(O)})]},B)})}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-3 border-t border-gray-200 pt-4",children:[a.label==="Paid"&&e.jsxs("a",{href:R((b=s.items[0])==null?void 0:b.ticket_pdf),target:"_blank",rel:"noreferrer",className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(G,{size:18})," Download Ticket(s)"]}),e.jsxs("button",{onClick:l=>{l.stopPropagation(),T(s.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(P,{size:18})," Check Status"]}),u&&!m&&e.jsxs("button",{onClick:l=>{l.stopPropagation(),_(s.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm ml-auto",children:[e.jsx(J,{size:18})," Pay Now"]})]}),m&&e.jsxs("div",{className:"mt-4 bg-white border border-blue-100 rounded-xl p-4 shadow-sm animate-in fade-in slide-in-from-top-2",children:[e.jsxs("h5",{className:"text-sm font-bold text-gray-800 mb-3",children:["Complete Payment for Order #",s.ref]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Email"}),e.jsx("input",{type:"email",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:j,onChange:l=>N(l.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Mobile"}),e.jsx("input",{type:"tel",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:k,onChange:l=>v(l.target.value)})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>A(s),disabled:g.status==="loading",className:"px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 shadow-md transition-all",children:g.status==="loading"?"Processing...":"Proceed to Payment Gateway"}),e.jsx("button",{onClick:()=>_(null),className:"px-4 py-2 text-gray-500 text-sm hover:text-gray-700 font-medium",children:"Cancel"})]})]})]})]},s.id)})})]})})}export{ge as default};
