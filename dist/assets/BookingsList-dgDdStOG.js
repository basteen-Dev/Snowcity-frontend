import{h as ve,A as je,u as ae,R as d,j as t,D as c}from"./index-CmreT6x1.js";import{l as k,a as D,A as N,r as ke,b as Ne}from"./AdminApp-BV7zANWg.js";import{A as Ce}from"./AdminTable-tpEZTVA3.js";import{A as Ae}from"./AdminPagination-DfJfzhiJ.js";import{F as oe}from"./file-spreadsheet-B54-irQn.js";import{F as se}from"./file-text-ButRzfWA.js";import{R as we,T as De}from"./CategoricalChart-DBf64Xqk.js";import{L as Re,a as ie}from"./LineChart-CVdFWwId.js";import{C as Ye,X as Se,Y as $e,L as Fe}from"./CartesianChart-KmrazZSN.js";import"./createLucideIcon-CgZNF2TE.js";import"./newspaper-yOb_4zvd.js";import"./ticket-hq6RMmhb.js";import"./chevron-down-bqKWLlrR.js";import"./clsx-B-dksMZM.js";import"./index-CWA4Ncqu.js";const M=({title:s,subtitle:b,children:p,className:u=""})=>t.jsxs("div",{className:`rounded-2xl border border-gray-200 bg-white p-5 shadow-sm dark:bg-neutral-900 dark:border-neutral-800 ${u}`,children:[t.jsx("div",{className:"flex items-center justify-between mb-4",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-neutral-100",children:s}),b?t.jsx("p",{className:"text-xs text-gray-500",children:b}):null]})}),p]}),B=({icon:s,label:b,value:p,note:u,accent:v="from-blue-500 to-indigo-600"})=>t.jsxs("div",{className:"rounded-2xl border border-gray-100 bg-white shadow-sm p-4 dark:bg-neutral-900 dark:border-neutral-800",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide",children:b}),t.jsx("div",{className:`mt-2 text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r ${v}`,children:p})]}),s]}),u?t.jsx("div",{className:"text-xs text-gray-500 mt-2",children:u}):null]}),F=s=>`â‚¹${Number(s||0).toLocaleString()}`,ne=s=>Number(s||0).toLocaleString(),I=Object.freeze({attraction:{from:"",to:"",attraction_id:""},combo:{from:"",to:"",attraction_id:"",combo_id:""}}),Pe=()=>({attraction:{...I.attraction},combo:{...I.combo}}),G=s=>{if(!s)return[];if(Array.isArray(s))return s;if(Array.isArray(s.data))return s.data;if(Array.isArray(s.items))return s.items;if(Array.isArray(s.results))return s.results;if(s.data&&Array.isArray(s.data.items))return s.data.items;if(s.data&&Array.isArray(s.data.results))return s.data.results;if(s.data&&Array.isArray(s.data.data))return s.data.data;if(s.meta&&Array.isArray(s.meta.data))return s.meta.data;if(typeof s.data=="object"&&s.data!==null&&!Array.isArray(s.data)&&Object.keys(s.data).length>0){const b=Object.values(s.data)[0];if(Array.isArray(b))return b}return[]},Oe=s=>c(s).format("YYYY-MM-DD");Oe(new Date);const re=[{key:"today",label:"Today",from:()=>c().startOf("day"),to:()=>c().endOf("day")},{key:"yesterday",label:"Yesterday",from:()=>c().subtract(1,"day").startOf("day"),to:()=>c().subtract(1,"day").endOf("day")},{key:"tomorrow",label:"Tomorrow",from:()=>c().add(1,"day").startOf("day"),to:()=>c().add(1,"day").endOf("day")},{key:"thisWeek",label:"This Week",from:()=>c().startOf("week"),to:()=>c().endOf("week")},{key:"thisMonth",label:"This Month",from:()=>c().startOf("month"),to:()=>c().endOf("month")},{key:"last7",label:"Last 7 days",from:()=>c().subtract(6,"day").startOf("day"),to:()=>c().endOf("day")},{key:"last30",label:"Last 30 days",from:()=>c().subtract(29,"day").startOf("day"),to:()=>c().endOf("day")},{key:"all",label:"All time",from:()=>null,to:()=>null}];function He(){var H,J,Z,ee;const s=ve(),b=je(),{list:p}=ae(e=>e.adminBookings),{user:u}=ae(e=>e.adminAuth),v=d.useMemo(()=>Array.isArray(p.data)?p.data:[],[p.data]),le=d.useMemo(()=>{const e=new Map;return v.forEach(a=>{a!=null&&a.booking_id&&e.set(a.booking_id,a)}),e},[v]),de=d.useMemo(()=>{const e={};return v.forEach(a=>{a!=null&&a.parent_booking_id&&(e[a.parent_booking_id]=(e[a.parent_booking_id]||0)+1)}),e},[v]),[o,x]=d.useState({search:"",payment_status:"",booking_status:"",attraction_id:"",combo_id:"",offer_id:"",user_email:"",user_phone:"",item_type:"",date_from:"",date_to:""}),[r,E]=d.useState({status:"idle",attractions:[],combos:[],offers:[]}),[y,T]=d.useState({status:"idle",trend:[],summary:null}),[z,R]=d.useState("all"),[_,C]=d.useState({attraction:{status:"idle",data:null},combo:{status:"idle",data:null}}),[g,V]=d.useState(Pe());d.useEffect(()=>{s(k({page:1,limit:20,payment_status:"Pending"})),Y(),P("both")},[]),d.useEffect(()=>{let e=!1;return(async()=>{if(r.status==="idle"){E(a=>({...a,status:"loading"}));try{const[a,n,i]=await Promise.all([D.get(N.attractions(),{params:{limit:1e3}}),D.get(N.combos(),{params:{limit:1e3}}),D.get(N.offers(),{params:{limit:1e3}})]);if(e)return;console.log("API Responses:",{attractionsRes:a,combosRes:n,offersRes:i});const l=Array.isArray(u==null?void 0:u.roles)?u.roles.map(w=>String(w).toLowerCase()):[],m=(u==null?void 0:u.scopes)||{},f=l.includes("subadmin")&&!l.includes("admin")&&!l.includes("root");let h=G(a),S=G(n);const _e=G(i);let W=h,q=S;if(f){const w=m.attraction||[],L=m.combo||[];console.log("Subadmin scopes:",{allowedAttractionIds:w,allowedComboIds:L}),w.length>0?W=h.filter($=>w.includes($.attraction_id)||w.includes($.id)):W=[],L.length>0?q=S.filter($=>L.includes($.combo_id)||L.includes($.id)):q=[]}const te={status:"succeeded",attractions:W,combos:q,offers:_e};console.log("Normalized data:",te),E(te)}catch(a){if(e)return;console.error("Error loading options:",a),E(n=>({...n,status:"failed",error:a}))}}})(),()=>{e=!0}},[u]);const A=d.useCallback((e={})=>{const a={...o,...e},n={};return Object.entries(a).forEach(([i,l])=>{l!=null&&(typeof l=="string"&&l.trim()===""||(n[i]=l))}),n},[o]),Y=d.useCallback(async()=>{T(e=>({...e,status:"loading"}));try{const e=await D.get(N.analyticsOverview(),{params:{from:o.date_from||void 0,to:o.date_to||void 0,attraction_id:o.attraction_id||void 0}}),a=Array.isArray(e==null?void 0:e.trend)?e.trend:[];T({status:"succeeded",trend:a,summary:(e==null?void 0:e.summary)||e})}catch(e){T(a=>({...a,status:"failed",error:e}))}},[o]),P=d.useCallback(async(e="both")=>{const a=e==="both"?["attraction","combo"]:[e];if(a.includes("attraction")){const n=g.attraction;C(i=>({...i,attraction:{status:"loading",data:null}}));try{const i=await D.get(N.analyticsAttractionRevenue(),{params:{from:n.from||o.date_from||void 0,to:n.to||o.date_to||void 0,attraction_id:n.attraction_id||o.attraction_id||void 0}});C(l=>({...l,attraction:{status:"succeeded",data:i}}))}catch(i){C(l=>({...l,attraction:{status:"failed",error:i}}))}}if(a.includes("combo")){const n=g.combo;C(i=>({...i,combo:{status:"loading",data:null}}));try{const i=await D.get(N.analyticsComboRevenue(),{params:{from:n.from||o.date_from||void 0,to:n.to||o.date_to||void 0,attraction_id:n.attraction_id||o.attraction_id||void 0,combo_id:n.combo_id||o.combo_id||void 0}});C(l=>({...l,combo:{status:"succeeded",data:i}}))}catch(i){C(l=>({...l,combo:{status:"failed",error:i}}))}}},[o,g]),O=d.useCallback((e,a)=>{var n,i,l,m;try{const f={type:e,from:((n=g[e==="attraction-revenue"?"attraction":"combo"])==null?void 0:n.from)||o.date_from||void 0,to:((i=g[e==="attraction-revenue"?"attraction":"combo"])==null?void 0:i.to)||o.date_to||void 0,attraction_id:((l=g[e==="attraction-revenue"?"attraction":"combo"])==null?void 0:l.attraction_id)||o.attraction_id||void 0,combo_id:((m=g[e==="combo-revenue"?"combo":"attraction"])==null?void 0:m.combo_id)||o.combo_id||void 0},h=`${N.analyticsReport(a)}?${new URLSearchParams(f).toString()}`;window.open(h,"_blank")}catch(f){console.error("Download failed:",f),alert("Failed to download report")}},[o,g]),ce=()=>{s(k({...A(),page:1,limit:20})),Y(),P("both")},j=(e,a,n)=>{V(i=>({...i,[e]:{...i[e],[a]:n}}))},K=e=>{P(e)},Q=e=>{V(a=>({...a,[e]:{...I[e]}})),P(e)},X=e=>{const i=(o.date_from?c(o.date_from):c()).add(e,"day").format("YYYY-MM-DD");x(m=>({...m,date_from:i,date_to:i})),R("custom");const l={...A({date_from:i,date_to:i}),page:1,limit:20};s(k(l))},me=d.useCallback(e=>{const a=re.find(m=>m.key===e);if(!a)return;const n=a.from(),i=a.to();x(m=>({...m,date_from:n?n.format("YYYY-MM-DD"):"",date_to:i?i.format("YYYY-MM-DD"):""})),R(e);const l={...A({date_from:n?n.format("YYYY-MM-DD"):void 0,date_to:i?i.format("YYYY-MM-DD"):void 0}),page:1,limit:20};s(k(l)),Y()},[A,s,Y]);d.useEffect(()=>{p.status==="succeeded"&&Y()},[p.status]);const U=p.meta||{},ue=U.totalPages||U.total_pages||1,xe=U.page||p.query.page||1,ge=d.useCallback(e=>{e&&b(`/admin/bookings/${e}`)},[b]),be=d.useCallback(e=>e?/^https?:/i.test(e)?e:`${"https://snowcity-backend-zjlj.onrender.com".replace(/\/$/,"")}${e}`:null,[]),pe=e=>{const a={user_email:e.user_email||"",user_phone:e.user_phone||""};x(i=>({...i,...a}));const n=A({...a,page:1});s(k({...n,page:1,limit:20}))},fe=e=>{if(!e.ticket_pdf){window.alert("Ticket PDF not available yet.");return}const a=be(e.ticket_pdf);a&&window.open(a,"_blank","noopener")},he=async e=>{if(e.booking_id&&window.confirm("Resend ticket via WhatsApp to this user?"))try{await s(ke({id:e.booking_id})).unwrap(),window.alert("WhatsApp ticket resend initiated.")}catch(a){window.alert((a==null?void 0:a.message)||"Failed to resend WhatsApp ticket")}},ye=async e=>{if(e.booking_id&&window.confirm("Resend ticket via email to this user?"))try{await s(Ne({id:e.booking_id})).unwrap(),window.alert("Email ticket resend initiated.")}catch(a){window.alert((a==null?void 0:a.message)||"Failed to resend email ticket")}};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Bookings Intelligence"}),t.jsx("div",{className:"flex gap-2 flex-wrap",children:re.map(e=>t.jsx("button",{onClick:()=>me(e.key),className:`rounded-full px-3 py-1 text-xs font-semibold border transition-colors ${z===e.key?"bg-gray-900 text-white border-gray-900":"border-gray-300 text-gray-600 hover:border-gray-500"}`,children:e.label},e.key))})]}),y.summary?t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsx(B,{label:"Paid Bookings",value:Number(y.summary.total_bookings||0).toLocaleString(),note:"Confirmed"}),t.jsx(B,{label:"Pending",value:Number(y.summary.pending_bookings||0).toLocaleString(),note:"Awaiting payment",accent:"from-amber-400 to-orange-500"}),t.jsx(B,{label:"Combo Revenue",value:F(y.summary.combo_revenue),note:`${y.summary.combo_bookings||0} combos`,accent:"from-indigo-500 to-purple-600"}),t.jsx(B,{label:"Offer Revenue",value:F(y.summary.offer_revenue),note:`${y.summary.offer_bookings||0} offers`,accent:"from-emerald-500 to-green-600"})]}):null,t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.jsxs(M,{title:"Attraction Revenue",subtitle:"Completed attraction bookings & revenue",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4",children:[t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2 flex-1",value:g.attraction.from,onChange:e=>j("attraction","from",e.target.value)}),t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2 flex-1",value:g.attraction.to,onChange:e=>j("attraction","to",e.target.value)}),t.jsxs("select",{className:"rounded-lg border px-3 py-2 flex-1 disabled:opacity-50",value:g.attraction.attraction_id,onChange:e=>j("attraction","attraction_id",e.target.value),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading...":"All attractions"}),r.status==="succeeded"&&(r.attractions||[]).length>0?(r.attractions||[]).map(e=>t.jsx("option",{value:e.attraction_id||e.id,children:e.title||e.name||`#${e.attraction_id||e.id}`},e.attraction_id||e.id)):null]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[t.jsx("button",{className:"rounded-lg bg-gray-900 text-white px-3 py-2 text-sm",onClick:()=>K("attraction"),children:"Apply"}),t.jsx("button",{className:"rounded-lg border px-3 py-2 text-sm",onClick:()=>Q("attraction"),children:"Reset"}),t.jsx("div",{className:"flex-1"}),t.jsxs("button",{className:"inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm",onClick:()=>O("attraction-revenue","csv"),children:[t.jsx(oe,{className:"h-4 w-4"}),"CSV"]}),t.jsxs("button",{className:"inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm",onClick:()=>O("attraction-revenue","pdf"),children:[t.jsx(se,{className:"h-4 w-4"}),"PDF"]})]}),t.jsx("div",{className:"rounded-xl border border-gray-100 p-4 bg-gray-50",children:_.attraction.status==="loading"?t.jsx("div",{className:"text-sm text-gray-500",children:"Loadingâ€¦"}):_.attraction.status==="failed"?t.jsx("div",{className:"text-sm text-red-600",children:"Failed to load data"}):t.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-500 uppercase text-xs",children:"Bookings"}),t.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:ne((H=_.attraction.data)==null?void 0:H.attraction_bookings)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-500 uppercase text-xs",children:"Revenue"}),t.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:F((J=_.attraction.data)==null?void 0:J.attraction_revenue)})]})]})})]}),t.jsxs(M,{title:"Combo Revenue",subtitle:"Combo bookings & linked revenue",children:[t.jsxs("div",{className:"flex flex-wrap gap-3 mb-4",children:[t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2 flex-1",value:g.combo.from,onChange:e=>j("combo","from",e.target.value)}),t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2 flex-1",value:g.combo.to,onChange:e=>j("combo","to",e.target.value)}),t.jsxs("select",{className:"rounded-lg border px-3 py-2 flex-1 disabled:opacity-50",value:g.combo.attraction_id,onChange:e=>j("combo","attraction_id",e.target.value),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading...":"All attractions"}),r.status==="succeeded"&&(r.attractions||[]).length>0?(r.attractions||[]).map(e=>t.jsx("option",{value:e.attraction_id||e.id,children:e.title||e.name||`#${e.attraction_id||e.id}`},e.attraction_id||e.id)):null]}),t.jsxs("select",{className:"rounded-lg border px-3 py-2 flex-1 disabled:opacity-50",value:g.combo.combo_id,onChange:e=>j("combo","combo_id",e.target.value),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading...":"All combos"}),r.status==="succeeded"&&(r.combos||[]).length>0?(r.combos||[]).map(e=>t.jsx("option",{value:e.combo_id||e.id,children:e.title||e.name||`Combo #${e.combo_id||e.id}`},e.combo_id||e.id)):null]})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[t.jsx("button",{className:"rounded-lg bg-gray-900 text-white px-3 py-2 text-sm",onClick:()=>K("combo"),children:"Apply"}),t.jsx("button",{className:"rounded-lg border px-3 py-2 text-sm",onClick:()=>Q("combo"),children:"Reset"}),t.jsx("div",{className:"flex-1"}),t.jsxs("button",{className:"inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm",onClick:()=>O("combo-revenue","csv"),children:[t.jsx(oe,{className:"h-4 w-4"}),"CSV"]}),t.jsxs("button",{className:"inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm",onClick:()=>O("combo-revenue","pdf"),children:[t.jsx(se,{className:"h-4 w-4"}),"PDF"]})]}),t.jsx("div",{className:"rounded-xl border border-gray-100 p-4 bg-gray-50",children:_.combo.status==="loading"?t.jsx("div",{className:"text-sm text-gray-500",children:"Loadingâ€¦"}):_.combo.status==="failed"?t.jsx("div",{className:"text-sm text-red-600",children:"Failed to load data"}):t.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-500 uppercase text-xs",children:"Combo bookings"}),t.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:ne((Z=_.combo.data)==null?void 0:Z.combo_bookings)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-500 uppercase text-xs",children:"Combo revenue"}),t.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:F((ee=_.combo.data)==null?void 0:ee.combo_revenue)})]})]})})]})]}),t.jsxs(M,{title:"Filters",subtitle:"Slice bookings by channel, product, and time",className:"p-4",children:[(()=>{const e=Array.isArray(u==null?void 0:u.roles)?u.roles.map(n=>String(n).toLowerCase()):[];return e.includes("subadmin")&&!e.includes("admin")&&!e.includes("root")?t.jsxs("div",{className:"bg-blue-50 text-blue-900 border border-blue-200 rounded-lg px-3 py-2 text-xs mb-3",children:[t.jsx("strong",{children:"Subadmin Access:"})," Viewing attractions and combos from your assigned bookings only."]}):null})(),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 mb-3",children:[t.jsx("input",{className:"rounded-lg border px-3 py-2",placeholder:"Search ref / user",value:o.search,onChange:e=>x({...o,search:e.target.value})}),t.jsxs("select",{className:"rounded-lg border px-3 py-2",value:o.payment_status,onChange:e=>x({...o,payment_status:e.target.value}),children:[t.jsx("option",{value:"",children:"Payment: All"}),t.jsx("option",{children:"Pending"}),t.jsx("option",{children:"Completed"}),t.jsx("option",{children:"Failed"}),t.jsx("option",{children:"Cancelled"})]}),t.jsxs("select",{className:"rounded-lg border px-3 py-2",value:o.booking_status,onChange:e=>x({...o,booking_status:e.target.value}),children:[t.jsx("option",{value:"",children:"Booking: All"}),t.jsx("option",{children:"Booked"}),t.jsx("option",{children:"Redeemed"}),t.jsx("option",{children:"Expired"}),t.jsx("option",{children:"Cancelled"})]}),t.jsxs("select",{className:"rounded-lg border px-3 py-2",value:o.item_type,onChange:e=>x({...o,item_type:e.target.value}),children:[t.jsx("option",{value:"",children:"Item Type"}),t.jsx("option",{value:"Attraction",children:"Attraction"}),t.jsx("option",{value:"Combo",children:"Combo"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 mb-3",children:[t.jsxs("select",{className:"rounded-lg border px-3 py-2 disabled:opacity-50",value:o.attraction_id,onChange:e=>x({...o,attraction_id:e.target.value}),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading attractions...":"Attraction"}),r.status==="succeeded"&&(r.attractions||[]).length>0?(r.attractions||[]).map(e=>t.jsx("option",{value:e.attraction_id||e.id,children:e.title||e.name||`#${e.attraction_id||e.id}`},e.attraction_id||e.id)):r.status==="failed"?t.jsx("option",{disabled:!0,children:"Failed to load attractions"}):null]}),t.jsxs("select",{className:"rounded-lg border px-3 py-2 disabled:opacity-50",value:o.combo_id,onChange:e=>x({...o,combo_id:e.target.value}),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading combos...":"Combo"}),r.status==="succeeded"&&(r.combos||[]).length>0?(r.combos||[]).map(e=>t.jsx("option",{value:e.combo_id||e.id,children:e.title||e.name||`Combo #${e.combo_id||e.id}`},e.combo_id||e.id)):r.status==="failed"?t.jsx("option",{disabled:!0,children:"Failed to load combos"}):null]}),t.jsxs("select",{className:"rounded-lg border px-3 py-2 disabled:opacity-50",value:o.offer_id,onChange:e=>x({...o,offer_id:e.target.value}),disabled:r.status==="loading",children:[t.jsx("option",{value:"",children:r.status==="loading"?"Loading offers...":"Offer"}),r.status==="succeeded"&&(r.offers||[]).length>0?(r.offers||[]).map(e=>t.jsx("option",{value:e.offer_id||e.id,children:e.title||e.name||e.code||`Offer #${e.offer_id||e.id}`},e.offer_id||e.id)):r.status==="failed"?t.jsx("option",{disabled:!0,children:"Failed to load offers"}):null]}),t.jsx("input",{className:"rounded-lg border px-3 py-2",placeholder:"User email",value:o.user_email,onChange:e=>x({...o,user_email:e.target.value})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 mb-3",children:[t.jsx("input",{className:"rounded-lg border px-3 py-2",placeholder:"User phone",value:o.user_phone,onChange:e=>x({...o,user_phone:e.target.value})}),t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2",value:o.date_from,onChange:e=>{const a=e.target.value;x({...o,date_from:a,date_to:a}),R("custom")}}),t.jsx("input",{type:"date",className:"rounded-lg border px-3 py-2",value:o.date_to,onChange:e=>{const a=e.target.value;x({...o,date_from:a,date_to:a}),R("custom")}}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{className:"flex-1 rounded-lg bg-gray-900 text-white px-3 py-2",onClick:ce,children:"Apply"}),t.jsx("button",{className:"rounded-lg border px-3 py-2",onClick:()=>{x({search:"",payment_status:"Pending",booking_status:"",attraction_id:"",combo_id:"",offer_id:"",user_email:"",user_phone:"",item_type:"",date_from:"",date_to:""}),s(k({page:1,limit:20,payment_status:"Pending"})),R("all")},children:"Reset"})]})]})]}),o.user_email||o.user_phone?t.jsxs("div",{className:"bg-blue-50 text-blue-900 border border-blue-100 rounded-xl px-4 py-2 text-sm",children:["Showing bookings for",o.user_email?t.jsxs(t.Fragment,{children:[" email ",t.jsx("strong",{children:o.user_email})]}):null,o.user_phone?t.jsxs(t.Fragment,{children:[" phone ",t.jsx("strong",{children:o.user_phone})]}):null]}):null,o.user_email||o.user_phone?t.jsxs("div",{className:"mb-4 text-sm text-gray-600",children:["Showing results for",o.user_email?t.jsxs(t.Fragment,{children:[" email ",t.jsx("strong",{children:o.user_email})]}):null,o.user_phone?t.jsxs(t.Fragment,{children:[" phone ",t.jsx("strong",{children:o.user_phone})]}):null]}):null,t.jsx(Ce,{keyField:"booking_id",columns:[{key:"booking_ref",title:"Ref"},{key:"booking_date",title:"Date",render:e=>e.booking_date?c(e.booking_date).format("DD MMM, YYYY"):"â€”"},{key:"user_email",title:"User",render:e=>t.jsxs("div",{className:"text-xs",children:[t.jsx("div",{children:e.user_email||"â€”"}),t.jsx("div",{className:"text-gray-500",children:e.user_phone||"â€”"})]})},{key:"item_title",title:"Item",render:e=>t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{children:e.item_title||e.attraction_title||"â€”"}),t.jsx("span",{className:"text-xs text-gray-500",children:e.item_type==="Combo"?"Combo":"Attraction"})]})},{key:"combo_title",title:"Combo/Offer",render:e=>t.jsxs("div",{className:"flex flex-col text-xs",children:[e.combo_title?t.jsxs("span",{children:["Combo: ",e.combo_title]}):null,e.offer_title?t.jsxs("span",{children:["Offer: ",e.offer_title]}):t.jsx("span",{className:"text-gray-400",children:"â€”"})]})},{key:"quantity",title:"Qty",render:e=>e.quantity?`${e.quantity}`:"1"},{key:"combo_context",title:"Combo Context",render:e=>{const a=e.item_type==="Combo",n=!!e.parent_booking_id,i=n?le.get(e.parent_booking_id):null,l=(i==null?void 0:i.booking_ref)||(i==null?void 0:i.booking_id)||e.parent_booking_id,m=de[e.booking_id]||0,f=(h,S="indigo")=>t.jsx("span",{className:`inline-flex w-fit items-center rounded-full px-2 py-0.5 text-xs font-medium bg-${S}-100 text-${S}-700`,children:h});return a?t.jsxs("div",{className:"flex flex-col gap-1 text-xs",children:[f("Combo parent"),t.jsx("span",{className:"text-gray-600",children:m?`${m} linked ${m===1?"attraction booking":"attraction bookings"}`:"Child bookings syncingâ€¦"})]}):n?t.jsxs("div",{className:"flex flex-col gap-1 text-xs",children:[f("Combo child","emerald"),t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs("span",{className:"text-gray-600",children:["Parent booking ",l?`#${l}`:"â€”",i!=null&&i.item_title?` Â· ${i.item_title}`:""]}),t.jsx("button",{className:"w-fit text-indigo-600 hover:underline",type:"button",onClick:h=>{h.stopPropagation(),ge(e.parent_booking_id)},children:"View parent"})]})]}):t.jsx("span",{className:"text-xs text-gray-400",children:"Standalone booking"})}},{key:"slot",title:"Slot",render:e=>{console.log("ðŸ” DEBUG Admin BookingsList item:",{booking_id:e.booking_id,slot_start_time:e.slot_start_time,slot_end_time:e.slot_end_time,booking_time:e.booking_time,slot_label:e.slot_label});const a=n=>{if(!n)return"";const[i,l]=n.split(":"),m=parseInt(i),f=m>=12?"PM":"AM";return`${m%12||12}:${l} ${f}`};if(e.slot_start_time&&e.slot_end_time){const n=`${a(e.slot_start_time)} - ${a(e.slot_end_time)}`;return console.log("ðŸ” DEBUG Admin using formatted slot times:",n),n}if(e.slot_label)return console.log("ðŸ” DEBUG Admin using slot_label:",e.slot_label),e.slot_label;if(e.booking_time){const n=a(e.booking_time);return console.log("ðŸ” DEBUG Admin using booking_time:",n),n}return console.log("ðŸ” DEBUG Admin no timing info available"),"â€”"}},{key:"payment_status",title:"Payment"},{key:"booking_status",title:"Status"},{key:"final_amount",title:"Amount",render:e=>`â‚¹${(e==null?void 0:e.final_amount)??(e==null?void 0:e.total_amount)??0}`},{key:"__actions",title:"",render:e=>t.jsxs("div",{className:"flex flex-wrap justify-end gap-3 text-xs",children:[t.jsx("button",{className:"text-blue-600 hover:underline",onClick:a=>{a.stopPropagation(),b(`/admin/bookings/${e.booking_id??e.id}`)},children:"Details"}),e.user_email||e.user_phone?t.jsx("button",{className:"text-gray-600 hover:underline",onClick:a=>{a.stopPropagation(),pe(e)},children:"User bookings"}):null,t.jsx("button",{className:`hover:underline ${e.ticket_pdf?"text-emerald-600":"text-gray-400 cursor-not-allowed"}`,onClick:a=>{a.stopPropagation(),fe(e)},disabled:!e.ticket_pdf,children:"Download ticket"}),t.jsx("button",{className:"text-green-600 hover:underline",onClick:a=>{a.stopPropagation(),he(e)},children:"WhatsApp"}),t.jsx("button",{className:"text-blue-600 hover:underline",onClick:a=>{a.stopPropagation(),ye(e)},children:"Email"})]})},{key:"addons",title:"Add-ons",render:e=>!e.addons||!e.addons.length?t.jsx("span",{className:"text-xs text-gray-400",children:"â€”"}):t.jsx("div",{className:"flex flex-col gap-1 text-xs",children:e.addons.map((a,n)=>t.jsxs("div",{className:"text-gray-600",children:["â€¢ ",a.title," x",a.quantity," (",F(a.price*a.quantity),")"]},n))})}],rows:v,onRowClick:e=>b(`/admin/bookings/${e.booking_id??e.id}`),empty:p.status==="loading"?"Loadingâ€¦":"No bookings"}),t.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-3",children:[t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>X(-1),children:"â—€ Prev Date"}),t.jsx("div",{className:"text-sm text-gray-600",children:z==="all"?"All bookings":o.date_from?c(o.date_from).format("dddd, DD MMM YYYY"):"No date selected"}),t.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>X(1),children:"Next Date â–¶"})]}),t.jsx(Ae,{page:xe,totalPages:ue,onPage:e=>s(k({...A(),page:e,limit:20}))}),t.jsx(M,{title:"Bookings Trend",subtitle:"Paid bookings vs revenue",className:"p-4",children:t.jsx("div",{style:{height:280},children:t.jsx(we,{width:"100%",height:"100%",children:t.jsxs(Re,{data:y.trend||[],children:[t.jsx(Ye,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),t.jsx(Se,{dataKey:"bucket"}),t.jsx($e,{}),t.jsx(De,{}),t.jsx(Fe,{}),t.jsx(ie,{type:"monotone",dataKey:"bookings",stroke:"#2563eb",name:"Bookings",strokeWidth:2,dot:!1}),t.jsx(ie,{type:"monotone",dataKey:"revenue",stroke:"#16a34a",name:"Revenue",strokeWidth:2,dot:!1})]})})})})]})}export{He as default};
