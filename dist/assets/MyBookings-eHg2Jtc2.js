import{h as z,u as y,r as x,X as M,j as e,D as P,S as q,Y as F}from"./index-uOjPOlE7.js";import{f as u}from"./formatters-CmiLqhJj.js";import{t as G}from"./media-D2Wlcy5m.js";import{c as _}from"./createLucideIcon-2KnKMZCN.js";import{C as R,F as Y}from"./file-text-DGJyf1Ue.js";import{C as Q}from"./circle-check-big-BDOxh7-M.js";import{C as X}from"./circle-alert-r6nZ8EMG.js";import{C as H}from"./clock-CT1FnMqN.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],K=_("chevron-up",J);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],W=_("credit-card",V);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]],D=_("refresh-ccw",Z),ee=({text:t,tone:n})=>{const i={green:"bg-green-100 text-green-700 border-green-200",red:"bg-red-100 text-red-700 border-red-200",yellow:"bg-yellow-100 text-yellow-800 border-yellow-200",gray:"bg-gray-100 text-gray-700 border-gray-200",blue:"bg-blue-100 text-blue-700 border-blue-200"};return e.jsx("span",{className:`px-2.5 py-0.5 rounded-full text-xs font-medium border ${i[n]||i.gray}`,children:t})},te=t=>{const n=String(t||"").trim().toUpperCase();return["COMPLETED","SUCCESS","PAID","CONFIRMED"].includes(n)?{tone:"green",icon:Q,label:"Paid"}:["FAILED","DECLINED","CANCELLED","CANCELED"].includes(n)?{tone:"red",icon:X,label:"Failed"}:{tone:"yellow",icon:H,label:"Pending"}},se=t=>{const n=String(t||"").replace(/\D/g,"");return n.length>=10?n.slice(-10):n},p=t=>{if(!t)return"";const[n,i]=String(t).split(":");if(!n||!i)return"";const o=parseInt(n,10),g=o>=12?"PM":"AM";return`${o%12||12}:${i} ${g}`},ae=(t=[])=>{if(!Array.isArray(t)||!t.length)return[];const n=new Map;t.forEach(o=>{n.set(o.booking_id,{...o,child_items:[]})}),n.forEach(o=>{o.parent_booking_id&&n.has(o.parent_booking_id)&&n.get(o.parent_booking_id).child_items.push(o)});const i=Array.from(n.values()).filter(o=>!o.parent_booking_id);return i.length?i:Array.from(n.values())},re=t=>t?String(t.item_type).toLowerCase()==="combo"?t.combo_title||t.combo_name||t.item_title||(t.combo_id?`Combo #${t.combo_id}`:"Combo"):t.item_title||t.attraction_title||"Ticket":"Ticket",ne=t=>{console.log("ðŸ” DEBUG MyBookings item data:",{booking_id:t.booking_id,slot_start_time:t.slot_start_time,slot_end_time:t.slot_end_time,start_time:t.start_time,end_time:t.end_time,slot_label:t.slot_label,booking_time:t.booking_time,full_item:t});const n=p(t.slot_start_time||t.start_time),i=p(t.slot_end_time||t.end_time);if(n&&i){const g=`${n} - ${i}`;return console.log("ðŸ” DEBUG MyBookings using start/end times:",g),g}if(n)return console.log("ðŸ” DEBUG MyBookings using start time only:",n),n;if(t.slot_label)return console.log("ðŸ” DEBUG MyBookings using slot_label:",t.slot_label),t.slot_label;const o=p(t.booking_time)||"Slot Time";return console.log("ðŸ” DEBUG MyBookings using booking_time fallback:",o),o};function ue(){const t=z(),{status:n,items:i,error:o}=y(a=>a.bookings.list),g=y(a=>a.bookings.payphi),c=y(a=>{var r;return(r=a.auth)==null?void 0:r.user}),j=x.useMemo(()=>{if(!Array.isArray(i))return[];const a=new Map;return i.forEach(r=>{const d=r.order_id||r.booking_id||r.id;a.has(d)||a.set(d,{id:d,ref:r.order_ref||r.booking_ref,date:r.created_at,status:r.payment_status,items:[],calculatedTotal:0}),a.get(d).items.push(r)}),a.forEach(r=>{r.primaryItems=ae(r.items),r.primaryItems.forEach(l=>{Array.isArray(l.child_items)&&l.child_items.length&&(l.child_items=[...l.child_items].sort((m,f)=>{const h=m.slot_start_time||m.booking_time||"",s=f.slot_start_time||f.booking_time||"";return String(h).localeCompare(String(s))}))});const d=r.primaryItems.length?r.primaryItems:r.items;r.itemCount=d.length,r.calculatedTotal=d.reduce((l,m)=>l+Number(m.final_amount||m.total_amount||0),0)}),Array.from(a.values()).sort((r,d)=>new Date(d.date)-new Date(r.date))},[i]),[S,A]=x.useState(null),[I,v]=x.useState(null),[N,k]=x.useState(""),[w,C]=x.useState("");x.useEffect(()=>{t(M({page:1,limit:50}))},[t]),x.useEffect(()=>{k((c==null?void 0:c.email)||""),C((c==null?void 0:c.phone)||"")},[c]);const E=()=>t(M({page:1,limit:50})),T=async a=>{const r=(N||(c==null?void 0:c.email)||"").trim(),d=se(w||(c==null?void 0:c.phone)||"");if(!r||!d||d.length<10){alert("Please enter a valid email and 10-digit mobile to continue.");return}try{const l=await t(q({bookingId:a.id,email:r,mobile:d})).unwrap();l!=null&&l.redirectUrl?window.location.href=l.redirectUrl:alert("Payment initiation failed. Please try again.")}catch(l){alert(`Payment failed: ${l.message||"Unknown error"}`)}},B=async a=>{await t(F({bookingId:a})).unwrap(),E()};return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-[#e0f2fe] via-[#bae6fd] to-white px-4 pt-20 pb-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"My Orders"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Track your tickets and payment status"})]}),e.jsx("button",{onClick:E,disabled:n==="loading",className:"p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors",title:"Refresh List",children:e.jsx(D,{size:20,className:n==="loading"?"animate-spin":""})})]}),n==="failed"&&e.jsx("div",{className:"bg-red-50 text-red-700 p-4 rounded-lg mb-6 text-sm text-center",children:(o==null?void 0:o.message)||"Failed to load orders."}),n==="succeeded"&&j.length===0&&e.jsx("div",{className:"text-center py-12 bg-gray-50 rounded-2xl border border-dashed border-gray-300",children:e.jsx("p",{className:"text-gray-500",children:"No orders found."})}),e.jsx("div",{className:"space-y-6",children:j.map(a=>{var h;const r=te(a.status),d=r.icon,l=S===a.id,m=I===a.id,f=r.label==="Pending";return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden transition-all hover:shadow-md",children:[e.jsxs("div",{className:"p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 cursor-pointer select-none",onClick:()=>A(l?null:a.id),children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full ${r.tone==="green"?"bg-green-50 text-green-600":r.tone==="red"?"bg-red-50 text-red-600":"bg-yellow-50 text-yellow-600"}`,children:e.jsx(d,{size:24})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["Order #",a.ref]}),e.jsx(ee,{text:r.label,tone:r.tone})]}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:P(a.date).format("DD MMM YYYY â€¢ h:mm A")}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[a.itemCount||a.items.length," Item",(a.itemCount||a.items.length)!==1&&"s"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between md:justify-end gap-6 w-full md:w-auto",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-semibold mb-1",children:"Total"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:u(a.calculatedTotal)})]}),e.jsx("div",{className:"text-gray-400",children:l?e.jsx(K,{size:24}):e.jsx(R,{size:24})})]})]}),l&&e.jsxs("div",{className:"border-t border-gray-100 bg-gray-50/50 p-5 animate-slide-down",children:[e.jsx("h4",{className:"text-xs font-bold text-gray-500 uppercase mb-3",children:"Order Items"}),e.jsx("div",{className:"space-y-3",children:(a.primaryItems&&a.primaryItems.length?a.primaryItems:a.items).map((s,O)=>{const L=ne(s),U=Number(s.final_amount||s.total_amount||0);return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200 flex flex-col md:flex-row md:items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800 text-base",children:re(s)}),e.jsxs("div",{className:"text-sm text-gray-500 mt-1 flex items-center gap-2",children:[e.jsx("span",{children:P(s.booking_date).format("DD MMM")}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsx("span",{children:L}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsxs("span",{children:["Qty: ",s.quantity]})]}),s.addons&&s.addons.length>0&&e.jsxs("div",{className:"mt-2 p-2 bg-gray-50 rounded text-xs",children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Add-ons:"}),s.addons.map((b,$)=>e.jsxs("div",{className:"text-gray-600",children:["â€¢ ",b.title," x",b.quantity," (",u(b.price*b.quantity),")"]},$))]}),s.offer&&e.jsxs("div",{className:"mt-2 p-2 bg-green-50 rounded text-xs",children:[e.jsx("div",{className:"font-semibold text-green-700 mb-1",children:"Offer Applied:"}),e.jsxs("div",{className:"text-green-600",children:[s.offer.title,s.offer.description&&e.jsx("div",{className:"text-green-500 mt-1",children:s.offer.description}),s.offer.rule_type==="buy_x_get_y"&&s.offer.buy_qty&&s.offer.get_qty&&e.jsxs("div",{className:"text-green-500 mt-1",children:["Buy ",s.offer.buy_qty," Get ",s.offer.get_qty,s.offer.get_discount_type==="percent"&&s.offer.get_discount_value&&e.jsxs("span",{children:[" (",s.offer.get_discount_value,"% off)"]}),s.offer.get_discount_type==="amount"&&s.offer.get_discount_value&&e.jsxs("span",{children:[" (",u(s.offer.get_discount_value)," off)"]}),!s.offer.get_discount_value&&e.jsx("span",{children:" Free"})]}),s.offer.rule_type!=="buy_x_get_y"&&s.offer.discount_type==="percent"&&e.jsxs("div",{className:"text-green-500",children:[s.offer.discount_percent,"% discount"]}),s.offer.rule_type!=="buy_x_get_y"&&s.offer.discount_type==="amount"&&e.jsxs("div",{className:"text-green-500",children:[u(s.offer.discount_value)," off"]})]})]})]}),e.jsx("div",{className:"font-bold text-gray-900",children:u(U)})]},O)})}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-3 border-t border-gray-200 pt-4",children:[r.label==="Paid"&&e.jsxs("a",{href:G((h=a.items[0])==null?void 0:h.ticket_pdf),target:"_blank",rel:"noreferrer",className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(Y,{size:18})," Download Ticket(s)"]}),e.jsxs("button",{onClick:s=>{s.stopPropagation(),B(a.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors",children:[e.jsx(D,{size:18})," Check Status"]}),f&&!m&&e.jsxs("button",{onClick:s=>{s.stopPropagation(),v(a.id)},className:"flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm ml-auto",children:[e.jsx(W,{size:18})," Pay Now"]})]}),m&&e.jsxs("div",{className:"mt-4 bg-white border border-blue-100 rounded-xl p-4 shadow-sm animate-in fade-in slide-in-from-top-2",children:[e.jsxs("h5",{className:"text-sm font-bold text-gray-800 mb-3",children:["Complete Payment for Order #",a.ref]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Email"}),e.jsx("input",{type:"email",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:N,onChange:s=>k(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Mobile"}),e.jsx("input",{type:"tel",className:"w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none",value:w,onChange:s=>C(s.target.value)})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>T(a),disabled:g.status==="loading",className:"px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 shadow-md transition-all",children:g.status==="loading"?"Processing...":"Proceed to Payment Gateway"}),e.jsx("button",{onClick:()=>v(null),className:"px-4 py-2 text-gray-500 text-sm hover:text-gray-700 font-medium",children:"Cancel"})]})]})]})]},a.id)})})]})})}export{ue as default};
