import{B,R as p,j as e}from"./index-LUC8W6HM.js";import{a as y,A as b}from"./AdminApp-BAIHpeWj.js";import{A as T}from"./AdminTable-BYWoXvnz.js";import"./createLucideIcon-BY9DOx5Q.js";import"./file-text-Bc3jcJvJ.js";import"./ticket-xkTq38T-.js";function q(){const N=B(),[d,c]=p.useState({status:"idle",items:[],error:null,attraction_id:"",page:1,limit:20,meta:null}),[r,u]=p.useState({status:"idle",items:[],slot:null,error:null}),[m,v]=p.useState([]),[g,_]=p.useState(0),h=async(t=1)=>{var a;c(i=>({...i,status:"loading",error:null,page:t}));try{const i=await y.get(b.slots(),{params:{attraction_id:d.attraction_id||void 0,page:t,limit:d.limit}}),s=Array.isArray(i==null?void 0:i.data)?i.data:Array.isArray(i)?i:[];c(o=>({...o,status:"succeeded",items:s,meta:(i==null?void 0:i.meta)||null,page:t}));const l=Array.from(new Set(s.map(o=>o.start_date))).sort();v(l);const n=l.indexOf(d.attraction_id?(a=s.find(o=>o.start_date))==null?void 0:a.start_date:void 0);_(n>=0?n:0)}catch(i){c(s=>({...s,status:"failed",error:i}))}};p.useEffect(()=>{h(1)},[]);const S=async(t,a)=>{var i;(i=a==null?void 0:a.stopPropagation)==null||i.call(a);try{const s=t.slot_id||t.id;await y.put(b.slotById(s),{available:!t.available}),c(l=>({...l,items:l.items.map(n=>(n.slot_id||n.id)===s?{...n,available:!t.available}:n)}))}catch(s){alert((s==null?void 0:s.message)||"Failed to update")}},A=async(t,a)=>{var i;if((i=a==null?void 0:a.stopPropagation)==null||i.call(a),!!window.confirm(`Delete slot #${t.slot_id||t.id}? This cannot be undone.`))try{const s=t.slot_id||t.id;await y.delete(b.slotById(s)),c(l=>({...l,items:l.items.filter(n=>(n.slot_id||n.id)!==s)}))}catch(s){alert((s==null?void 0:s.message)||"Delete failed")}},C=async t=>{const a=t.slot_id||t.id,i=s=>{if(s){if(/^\d{2}:\d{2}:\d{2}$/.test(s))return s;if(/^\d{1,2}:\d{2}$/.test(s))return`${s.length===4?"0":""}${s}:00`;if(/\s/.test(s)){const l=new Date(`1970-01-01T${s}`);if(!isNaN(l.getTime())){const n=String(l.getHours()).padStart(2,"0"),o=String(l.getMinutes()).padStart(2,"0"),P=String(l.getSeconds()).padStart(2,"0");return`${n}:${o}:${P}`}}}};u({status:"loading",items:[],slot:t,error:null});try{const s=await y.get(b.bookings(),{params:{slot_id:a,slot_start_time:i(t.start_time||t.start_time_12h||t.start_time_24h),slot_end_time:i(t.end_time||t.end_time_12h||t.end_time_24h),limit:100}}),l=Array.isArray(s==null?void 0:s.data)?s.data:Array.isArray(s)?s:[];u({status:"succeeded",items:l,slot:t,error:null})}catch(s){u({status:"failed",items:[],slot:t,error:s})}},D=()=>u({status:"idle",items:[],slot:null,error:null}),x=d.meta||{},f=d.page>1,k=x.page?x.page<(x.totalPages||x.total_pages||1):!1,j=m[g],$=j?d.items.filter(t=>t.start_date===j):d.items;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Slots"}),e.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>N("/admin/catalog/combo-slots"),children:"Combo Slots Module"})]}),e.jsxs("div",{className:"mb-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("input",{className:"rounded-md border px-3 py-2",placeholder:"Filter by attraction_id",value:d.attraction_id,onChange:t=>c(a=>({...a,attraction_id:t.target.value}))}),e.jsx("button",{className:"rounded-md border px-3 py-2 text-sm",onClick:()=>h(1),children:"Filter"})]}),e.jsx(T,{keyField:"slot_id",columns:[{key:"slot_id",title:"ID"},{key:"attraction_id",title:"Attraction"},{key:"start_date",title:"Start Date"},{key:"end_date",title:"End Date"},{key:"start_time",title:"Start Time",render:t=>t.start_time_12h||t.start_time},{key:"end_time",title:"End Time",render:t=>t.end_time_12h||t.end_time},{key:"capacity",title:"Capacity"},{key:"available",title:"Available",render:t=>String(t==null?void 0:t.available)},{key:"__actions",title:"Actions",render:t=>e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:`rounded-md px-2 py-1 text-xs ${t.available?"border text-red-600":"bg-blue-600 text-white"}`,onClick:a=>S(t,a),children:t.available?"Disable":"Enable"}),e.jsx("button",{className:"rounded-md border px-2 py-1 text-xs text-red-600",onClick:a=>A(t,a),children:"Delete"}),e.jsx("button",{className:"rounded-md border px-2 py-1 text-xs",onClick:a=>{a.stopPropagation(),N(`/admin/catalog/slots/${t.slot_id||t.id}`)},children:"Edit"})]})}],rows:$,onRowClick:t=>C(t),empty:d.status==="loading"?"Loading…":"No slots for this date"}),m.length>1&&e.jsxs("div",{className:"mt-3 flex items-center gap-3 text-sm",children:[e.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>_(t=>Math.max(0,t-1)),disabled:g===0,children:"Prev Date"}),e.jsxs("div",{className:"text-gray-600",children:[j||"—"," (",g+1," / ",m.length,")"]}),e.jsx("button",{className:"rounded-md border px-3 py-1",onClick:()=>_(t=>Math.min(m.length-1,t+1)),disabled:g>=m.length-1,children:"Next Date"})]}),e.jsxs("div",{className:"mt-6 rounded-xl border bg-white p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Bookings for selected slot"}),r.slot?e.jsx("button",{className:"text-sm text-blue-600 hover:underline",onClick:D,children:"Clear selection"}):null]}),!r.slot&&e.jsx("p",{className:"text-sm text-gray-500",children:"Click a slot above to view its bookings."}),r.slot?r.status==="loading"?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading bookings…"}):r.status==="failed"?e.jsx("p",{className:"text-sm text-red-600",children:"Failed to load bookings."}):r.items.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No bookings found for this slot."}):e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b text-left text-gray-500",children:[e.jsx("th",{className:"py-2 pr-3",children:"Booking Ref"}),e.jsx("th",{className:"py-2 pr-3",children:"User"}),e.jsx("th",{className:"py-2 pr-3",children:"Quantity"}),e.jsx("th",{className:"py-2 pr-3",children:"Status"}),e.jsx("th",{className:"py-2 pr-3",children:"Payment"})]})}),e.jsx("tbody",{children:r.items.map(t=>e.jsxs("tr",{className:"border-b last:border-b-0",children:[e.jsx("td",{className:"py-2 pr-3",children:t.booking_ref||`#${t.booking_id}`}),e.jsxs("td",{className:"py-2 pr-3",children:[e.jsx("div",{children:t.user_email||"—"}),e.jsx("div",{className:"text-gray-500",children:t.user_phone||""})]}),e.jsx("td",{className:"py-2 pr-3",children:t.quantity||0}),e.jsx("td",{className:"py-2 pr-3",children:t.booking_status||"—"}),e.jsx("td",{className:"py-2 pr-3",children:t.payment_status||"—"})]},t.booking_id))})]})}):null]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>f&&h(d.page-1),disabled:!f||d.status==="loading",children:"Prev"}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",x.page||d.page]}),e.jsx("button",{className:"rounded-md border px-3 py-1 text-sm",onClick:()=>k&&h(d.page+1),disabled:!k||d.status==="loading",children:"Next"})]})]})}export{q as default};
