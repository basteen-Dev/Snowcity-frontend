import{R as m,D as i,r as W,j as e}from"./index-LUC8W6HM.js";import{a as Y}from"./AdminApp-BAIHpeWj.js";import{f as b}from"./formatters-CmiLqhJj.js";import{R as T,T as O}from"./CategoricalChart-Ct6we7W-.js";import{L as G,a as E}from"./LineChart-DV8uQ4i-.js";import{C as Q,X as V,Y as X,L as H}from"./CartesianChart-C10HTeXy.js";import{P as I,a as z}from"./PieChart-Vd0_4Sfl.js";import{C as J}from"./tooltipContext-o6GB5qD6.js";import"./createLucideIcon-BY9DOx5Q.js";import"./file-text-Bc3jcJvJ.js";import"./ticket-xkTq38T-.js";import"./clsx-B-dksMZM.js";import"./index-CgmsNRzu.js";const Z=(a={})=>{const r=new URLSearchParams;return Object.entries(a).forEach(([o,n])=>{n==null||n===""||r.append(o,n)}),r.toString()},ee=(a,r)=>{const o=new Date().toISOString().replace(/[:.]/g,"-");return`analytics_${a||"report"}_${o}.${r}`};function te(){const[a,r]=m.useState(!1),[o,n]=m.useState(null);return{download:m.useCallback(async({type:p="bookings",ext:l="csv",params:w={},filename:M}={})=>{r(!0),n(null);try{const u=Z({type:p,...w}),g=`/api/admin/analytics/report.${l}${u?`?${u}`:""}`,f=await Y.get(g,{responseType:"blob",fullResponse:!0}),v=f==null?void 0:f.data;if(!v)throw new Error("No data returned");const N=M||ee(p,l),h=window.URL.createObjectURL(v),x=document.createElement("a");return x.href=h,x.download=N,document.body.appendChild(x),x.click(),document.body.removeChild(x),window.URL.revokeObjectURL(h),!0}catch(u){return n(u),!1}finally{r(!1)}},[]),downloading:a,error:o}}const S=[{key:"all",label:"All Time",get:()=>({from:void 0,to:void 0})},{key:"today",label:"Today",get:()=>({from:i().format("YYYY-MM-DD"),to:i().format("YYYY-MM-DD")})},{key:"yesterday",label:"Yesterday",get:()=>({from:i().subtract(1,"day").format("YYYY-MM-DD"),to:i().subtract(1,"day").format("YYYY-MM-DD")})},{key:"past7",label:"Past Week",get:()=>({from:i().subtract(7,"day").format("YYYY-MM-DD"),to:i().format("YYYY-MM-DD")})},{key:"thisMonth",label:"This Month",get:()=>({from:i().startOf("month").format("YYYY-MM-DD"),to:i().endOf("month").format("YYYY-MM-DD")})}],F=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#14b8a6","#e11d48","#22c55e","#f97316","#3b82f6"],ae=[{key:"total_bookings",label:"Confirmed Bookings",accent:"from-blue-500 to-indigo-600",formatter:a=>Number(a||0).toLocaleString(),note:"Paid orders"},{key:"pending_bookings",label:"Pending Bookings",accent:"from-amber-400 to-orange-500",formatter:a=>Number(a||0).toLocaleString(),note:"Awaiting payment"},{key:"total_revenue",label:"Revenue (Paid)",accent:"from-emerald-500 to-green-600",formatter:a=>b(a||0),note:"Captured revenue"},{key:"pending_revenue",label:"Pending Revenue",accent:"from-rose-500 to-pink-500",formatter:a=>b(a||0),note:"Held in cart / unpaid"},{key:"total_people",label:"Tickets (People)",accent:"from-slate-500 to-slate-700",formatter:a=>Number(a||0).toLocaleString()},{key:"unique_users",label:"Unique Users",accent:"from-teal-500 to-cyan-500",formatter:a=>Number(a||0).toLocaleString()},{key:"today_bookings",label:"Today",accent:"from-purple-500 to-fuchsia-500",formatter:a=>Number(a||0).toLocaleString(),note:"Paid today"}],K=(a=0)=>Number(a||0).toLocaleString(),k=({title:a,subtitle:r,children:o,className:n=""})=>e.jsxs("div",{className:`rounded-2xl border border-gray-200 bg-white p-5 shadow-sm dark:bg-neutral-900 dark:border-neutral-800 ${n}`,children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900 dark:text-neutral-100",children:a}),r?e.jsx("p",{className:"text-xs text-gray-500",children:r}):null]})}),o]}),se=({label:a,value:r,note:o,accent:n})=>e.jsxs("div",{className:"rounded-2xl border border-gray-100 bg-white shadow-sm p-4 dark:bg-neutral-900 dark:border-neutral-800",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide",children:a}),e.jsx("div",{className:`mt-3 text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r ${n}`,children:r}),o?e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:o}):null]});function fe(){const[a,r]=m.useState("all"),[o,n]=m.useState(i().format("YYYY-MM")),[L,p]=m.useState(!1),[l,w]=m.useState(null),[M,u]=m.useState([]),[g,f]=m.useState([]),{download:v,downloading:N,error:h}=te(),x=()=>{if(a==="customMonth"){const s=i(`${o}-01`);return{from:s.startOf("month").format("YYYY-MM-DD"),to:s.endOf("month").format("YYYY-MM-DD")}}return(S.find(s=>s.key===a)||S[0]).get()};async function U(){p(!0);try{const{from:t,to:s}=x(),d={};t&&(d.from=t),s&&(d.to=s);const c=await Y.get("/api/admin/analytics/overview",d);w((c==null?void 0:c.summary)||c);const y=await Y.get("/api/admin/analytics/trend",{...d,granularity:"day"});u(Array.isArray(y)?y:(y==null?void 0:y.data)||[]);const j=await Y.get("/api/admin/analytics/top-attractions",{...d,limit:10});f(Array.isArray(j)?j:(j==null?void 0:j.data)||[])}finally{p(!1)}}m.useEffect(()=>{U()},[a,o]);const{from:q,to:B}=x(),P=[{label:"CSV",ext:"csv"},{label:"Excel",ext:"xlsx"},{label:"PDF",ext:"pdf"}],$=(t,s)=>()=>v({type:t,ext:s,params:{from:q,to:B}}),D=Number((l==null?void 0:l.total_revenue)||0),C=Number((l==null?void 0:l.pending_revenue)||0),A=D+C,_=A?Math.round(D/A*100):0,R=W.useMemo(()=>(g||[]).slice(0,6),[g]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(k,{title:"Performance Filters",subtitle:"Quickly slice data by period",className:"p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(t=>e.jsx("button",{onClick:()=>r(t.key),className:`px-3 py-1.5 rounded-full text-sm border transition-colors ${a===t.key?"bg-gray-900 text-white border-gray-900":"border-gray-200 text-gray-700 hover:border-gray-400"}`,children:t.label},t.key))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>r("customMonth"),className:`px-3 py-1.5 rounded-full text-sm border ${a==="customMonth"?"bg-gray-900 text-white border-gray-900":"border-gray-200 text-gray-700 hover:border-gray-400"}`,children:"Month"}),e.jsx("input",{type:"month",className:"rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:ring-2 focus:ring-gray-900",value:o,onChange:t=>n(t.target.value)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 ml-auto",children:[P.map(t=>e.jsxs("button",{type:"button",className:"px-3 py-1.5 rounded-full border text-sm disabled:opacity-50",onClick:$("trend",t.ext),disabled:N,children:["Trend ",t.label]},`trend-${t.ext}`)),P.map(t=>e.jsxs("button",{type:"button",className:"px-3 py-1.5 rounded-full border text-sm disabled:opacity-50",onClick:$("top-attractions",t.ext),disabled:N,children:["Attractions ",t.label]},`attr-${t.ext}`))]})]}),h&&e.jsx("p",{className:"text-xs text-red-600 mt-2",children:h.message||"Failed to download report."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4",children:ae.map(t=>e.jsx(se,{label:t.label,value:t.formatter(l==null?void 0:l[t.key]),note:t.note,accent:t.accent},t.key))}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-4",children:[e.jsx(k,{title:"Daily Momentum",subtitle:"Confirmed bookings vs visitors",className:"xl:col-span-2",children:e.jsx("div",{style:{height:300},children:e.jsx(T,{width:"100%",height:"100%",children:e.jsxs(G,{data:M||[],children:[e.jsx(Q,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),e.jsx(V,{dataKey:"bucket",tickFormatter:t=>i(t).format("MM-DD")}),e.jsx(X,{}),e.jsx(O,{labelFormatter:t=>i(t).format("YYYY-MM-DD")}),e.jsx(H,{}),e.jsx(E,{type:"monotone",dataKey:"bookings",stroke:"#2563eb",name:"Bookings",strokeWidth:2,dot:!1}),e.jsx(E,{type:"monotone",dataKey:"people",stroke:"#10b981",name:"People",strokeWidth:2,dot:!1})]})})})}),e.jsx(k,{title:"Revenue Mix",subtitle:"Paid vs pending inflows",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 mb-2",children:[e.jsx("span",{children:"Paid"}),e.jsx("span",{children:b(D)})]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-100",children:e.jsx("div",{className:"h-full rounded-full bg-emerald-500",style:{width:`${_}%`}})})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 mb-2",children:[e.jsx("span",{children:"Pending"}),e.jsx("span",{children:b(C)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"rounded-xl bg-emerald-50 p-3",children:[e.jsx("p",{className:"text-xs text-emerald-600 uppercase",children:"Conversion"}),e.jsxs("p",{className:"text-2xl font-semibold text-emerald-700",children:[_,"%"]})]}),e.jsxs("div",{className:"rounded-xl bg-amber-50 p-3",children:[e.jsx("p",{className:"text-xs text-amber-600 uppercase",children:"Open Value"}),e.jsx("p",{className:"text-2xl font-semibold text-amber-700",children:b(C)})]})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(k,{title:"Top Attractions",subtitle:"Ranked by paid bookings",children:e.jsxs("div",{className:"space-y-3",children:[R.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"No data available."}),R.map((t,s)=>{var c;const d=t.bookings?Math.min(100,t.bookings/(((c=R[0])==null?void 0:c.bookings)||1)*100):0;return e.jsxs("div",{className:"p-3 rounded-xl border border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm font-medium text-gray-800",children:[e.jsxs("span",{children:[s+1,". ",t.title]}),e.jsxs("span",{children:[K(t.bookings)," bookings"]})]}),e.jsx("div",{className:"h-2 rounded-full bg-gray-100 mt-2",children:e.jsx("div",{className:"h-full rounded-full bg-gradient-to-r from-blue-500 to-indigo-500",style:{width:`${d}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["People: ",K(t.people)]}),e.jsxs("span",{children:["Revenue: ",b(t.revenue)]})]})]},t.attraction_id||s)})]})}),e.jsx(k,{title:"Share of Bookings",subtitle:"Top 10 attractions",children:e.jsx("div",{style:{height:320},children:e.jsx(T,{width:"100%",height:"100%",children:e.jsxs(I,{children:[e.jsx(z,{data:g||[],dataKey:"bookings",nameKey:"title",innerRadius:70,outerRadius:110,paddingAngle:2,children:(g||[]).map((t,s)=>e.jsx(J,{fill:F[s%F.length]},s))}),e.jsx(O,{formatter:(t,s,d)=>{var c;return[`${t} bookings`,((c=d==null?void 0:d.payload)==null?void 0:c.title)||s]}})]})})})})]}),L?e.jsx("div",{className:"text-sm text-gray-500",children:"Refreshing analyticsâ€¦"}):null]})}export{fe as default};
