import{C as O,B as $,R as n,j as t}from"./index-CNdOvwUA.js";import{a as g,A as v}from"./AdminApp-sxxeVGC_.js";import{I as D}from"./ImageUploader-BR89ENI0.js";import{u as T}from"./useCatalogTargets-CzVh11Q7.js";import"./createLucideIcon-D7GIchwo.js";import"./file-text-B3yKuaPb.js";import"./ticket-BYx_I3BZ.js";import"./media-Ct2xuz47.js";function Q(){var S,U,L;const{id:x}=O(),f=$(),m=!!x,[d,b]=n.useState({status:m?"loading":"idle",error:null,form:{media_type:"image",url:"",title:"",description:"",active:!0,target_type:"none",target_ref_id:null}});n.useEffect(()=>{m&&(async()=>{try{const e=await g.get(v.galleryById(x)),a=(e==null?void 0:e.gallery)||e||{};b(l=>({...l,status:"idle",form:{media_type:a.media_type||"image",url:a.url||"",title:a.title||"",description:a.description||"",active:a.active!==void 0?!!a.active:!0,target_type:a.target_type||"none",target_ref_id:a.target_ref_id||null}}))}catch(e){b(a=>({...a,status:"failed",error:e}))}})()},[x,m]);const i=e=>b(a=>({...a,form:{...a.form,...e}})),{attractions:N=[],combos:_=[],status:w}=T(),B=n.useMemo(()=>({attraction:N.map(e=>({value:e.attraction_id||e.id,label:e.title||e.name||`Attraction #${e.attraction_id||e.id}`})),combo:_.map(e=>({value:e.combo_id||e.id,label:e.title||e.name||`Combo #${e.combo_id||e.id}`}))}),[N,_]),A=async e=>{e.preventDefault();try{const{media_type:a,url:l,title:o,description:s,active:h,target_type:y,target_ref_id:k}=d.form;if(!a||!l)throw new Error("Media type and URL are required");const R={media_type:a,url:l,title:o,description:s,active:h,target_type:y,target_ref_id:y==="none"?null:k||null};m?await g.put(v.galleryById(x),R):await g.post(v.gallery(),R),f("/admin/catalog/gallery")}catch(a){b(l=>({...l,error:a}))}},E="/api/admin/uploads",[c,j]=n.useState([]),[C,I]=n.useState([]),[p,u]=n.useState({uploading:!1,progress:0,error:null});n.useEffect(()=>{const e=(c||[]).map(a=>({name:a.name,url:URL.createObjectURL(a),size:a.size,type:a.type}));return I(e),()=>e.forEach(a=>URL.revokeObjectURL(a.url))},[c]);const P=e=>{const a=Array.from(e.target.files||[]).filter(l=>l&&l.type&&l.type.startsWith("image/"));j(a),u({uploading:!1,progress:0,error:null})},F=e=>j(a=>a.filter((l,o)=>o!==e)),M=async()=>{var l;if(!c.length)return;u({uploading:!0,progress:0,error:null});const e=c.length;let a=0;try{for(const o of c){const s=await g.upload(E,o),h=(s==null?void 0:s.url)||(s==null?void 0:s.secure_url)||(s==null?void 0:s.location)||((l=s==null?void 0:s.data)==null?void 0:l.url)||"";if(!h)throw new Error("Upload response missing URL for "+(o.name||"file"));const y={media_type:"image",url:h,title:o.name,description:"",active:!0,target_type:d.form.target_type||"none",target_ref_id:d.form.target_type==="none"?null:d.form.target_ref_id||null};await g.post(v.gallery(),y),a+=1,u(k=>({...k,progress:Math.round(a/e*100)}))}u(o=>({...o,uploading:!1,progress:100})),f("/admin/catalog/gallery")}catch(o){u({uploading:!1,progress:Math.round(a/e*100),error:o})}};if(d.status==="loading")return t.jsx("div",{children:"Loading…"});if(d.status==="failed")return t.jsx("div",{className:"text-red-600",children:((S=d.error)==null?void 0:S.message)||"Failed to load"});const r=d.form;return t.jsxs("form",{onSubmit:A,className:"max-w-2xl bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl p-4",children:[t.jsxs("h1",{className:"text-xl font-semibold mb-4",children:[m?"Edit":"New"," Gallery Item"]}),d.error?t.jsx("div",{className:"mb-3 text-sm text-red-600",children:((U=d.error)==null?void 0:U.message)||"Save failed"}):null,t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Media Type"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.media_type,onChange:e=>i({media_type:e.target.value}),children:[t.jsx("option",{value:"image",children:"Image"}),t.jsx("option",{value:"video",children:"Video"})]})]}),t.jsx("div",{className:"md:col-span-2",children:r.media_type==="image"?t.jsxs("div",{children:[t.jsx(D,{label:"Image",value:r.url,onChange:e=>i({url:e}),folder:"gallery",requiredPerm:"uploads:write"}),t.jsxs("div",{className:"mt-4 border-t pt-4",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Bulk Upload Images"}),t.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:P,className:"text-sm"}),C.length?t.jsx("div",{className:"mt-3 grid grid-cols-3 md:grid-cols-6 gap-2",children:C.map((e,a)=>t.jsxs("div",{className:"relative group",children:[t.jsx("img",{src:e.url,alt:e.name,className:"w-full h-24 object-cover rounded-md border"}),t.jsx("button",{type:"button",onClick:()=>F(a),className:"absolute top-1 right-1 bg-white/80 text-xs rounded-full px-2 py-0.5",children:"Remove"})]},e.url))}):t.jsx("div",{className:"mt-2 text-sm text-gray-500",children:"No files selected for bulk upload."}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:M,className:"rounded-md bg-blue-600 text-white px-3 py-1.5 text-sm",disabled:p.uploading||!c.length,children:p.uploading?`Uploading (${p.progress}%)`:"Upload All"}),t.jsx("button",{type:"button",onClick:()=>{j([]),u({uploading:!1,progress:0,error:null})},className:"rounded-md border px-3 py-1.5 text-sm",children:"Clear"}),p.error?t.jsx("div",{className:"text-sm text-red-600",children:((L=p.error)==null?void 0:L.message)||"Upload failed"}):null]})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Video URL"}),t.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",placeholder:"https://…",value:r.url,onChange:e=>i({url:e.target.value})})]})}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Title"}),t.jsx("input",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.title,onChange:e=>i({title:e.target.value})})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Description"}),t.jsx("textarea",{rows:3,className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.description,onChange:e=>i({description:e.target.value})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Link to"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_type,onChange:e=>i({target_type:e.target.value,target_ref_id:null}),children:[t.jsx("option",{value:"none",children:"No specific page"}),t.jsx("option",{value:"attraction",children:"Attraction"}),t.jsx("option",{value:"combo",children:"Combo"})]})]}),r.target_type!=="none"?t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:r.target_type==="attraction"?"Select attraction":"Select combo"}),t.jsxs("select",{className:"w-full rounded-md border px-3 py-2 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200",value:r.target_ref_id||"",onChange:e=>i({target_ref_id:e.target.value?Number(e.target.value):null}),disabled:w==="loading",children:[t.jsx("option",{value:"",children:w==="loading"?"Loading…":"Select an option"}),(B[r.target_type]||[]).map(e=>t.jsx("option",{value:e.value||"",children:e.label},`${r.target_type}-${e.value}`))]})]}):null,t.jsxs("div",{className:"flex items-center gap-2 md:col-span-2",children:[t.jsx("input",{id:"active",type:"checkbox",checked:!!r.active,onChange:e=>i({active:e.target.checked})}),t.jsx("label",{htmlFor:"active",className:"text-sm text-gray-700 dark:text-neutral-200",children:"Active"})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"block text-sm text-gray-600 dark:text-neutral-300 mb-1",children:"Preview"}),t.jsx("div",{className:"w-full h-48 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:r.url?r.media_type==="video"?t.jsx("video",{className:"w-full h-full object-cover",src:r.url,muted:!0,controls:!0,preload:"metadata"}):t.jsx("img",{className:"w-full h-full object-cover",src:r.url,alt:r.title||"Preview"}):t.jsx("div",{className:"text-sm text-gray-500",children:"No media selected"})})]})]}),t.jsxs("div",{className:"mt-4 flex gap-2",children:[t.jsx("button",{type:"submit",className:"rounded-md bg-gray-900 text-white px-4 py-2 text-sm",children:"Save"}),t.jsx("button",{type:"button",className:"rounded-md border px-4 py-2 text-sm",onClick:()=>f(-1),children:"Cancel"})]})]})}export{Q as default};
